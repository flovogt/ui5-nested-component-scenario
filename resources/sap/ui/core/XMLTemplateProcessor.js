/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/DataType","sap/ui/base/ManagedObject","sap/ui/core/CustomData","sap/ui/core/Component","./mvc/View","./mvc/ViewType","./mvc/XMLProcessingMode","./mvc/EventHandlerResolver","./ExtensionPoint","./StashedControlSupport","sap/ui/base/SyncPromise","sap/base/Log","sap/base/util/ObjectPath","sap/base/util/values","sap/base/assert","sap/base/security/encodeXML","sap/base/util/LoaderExtensions","sap/base/util/JSTokenizer","sap/base/util/isEmptyObject"],function(e,t,n,r,i,a,o,s,u,l,f,c,p,d,g,m,v,h,w,b){"use strict";function y(e,r,i,a,o){var s=n.bindingParser(r,a,true,false,false,false,o);if(s&&typeof s==="object"){return s}var u=r=typeof s==="string"?s:r;var l=t.getType(e);if(l){if(l instanceof t){u=l.parseValue(r,{context:a,locals:o});if(!l.isValid(u)){p.error("Value '"+r+"' is not valid for type '"+l.getName()+"'.")}}}else{throw new Error("Property "+i+" has unknown type "+e)}return typeof u==="string"?n.bindingParser.escape(u):u}function C(e){return e.localName||e.nodeName}var _="http://www.w3.org/1999/xhtml";var x="http://www.w3.org/2000/xmlns/";var I="http://www.w3.org/2000/svg";var A="sap.ui.core";var M="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1";var N="http://schemas.sap.com/sapui5/extension/sap.ui.core.support.Support.info/1";var V="http://schemas.sap.com/sapui5/extension/sap.ui.core.xmlcomposite/1";var P="http://schemas.sap.com/sapui5/extension/sap.ui.core.Internal/1";var S="http://schemas.sap.com/sapui5/preprocessorextension/";var E=/^(?:area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)$/;function R(e,t){function n(e,n,r,i,a){var o,s,u=[];for(o=e.firstChild;o;o=o.nextSibling){s=t(e,n,r,o,false,i,a);if(s){u.push(s.unwrap())}}return c.resolve(u)}function r(e,n,r,i,a){var o,s=Promise.resolve(),u=[i];for(o=e.firstChild;o;o=o.nextSibling){s=s.then(t.bind(null,e,n,r,o,false,i,a));u.push(s)}return Promise.all(u)}return e?r:n}var T={};T.loadTemplate=function(e,t){var n=e.replace(/\./g,"/")+("."+(t||"view")+".xml");return h.loadResource(n).documentElement};T.loadTemplatePromise=function(e,t){var n=e.replace(/\./g,"/")+("."+(t||"view")+".xml");return h.loadResource(n,{async:true}).then(function(e){return e.documentElement})};T.parseViewAttributes=function(e,t,n){var r=t.getMetadata().getAllProperties();for(var i=0;i<e.attributes.length;i++){var a=e.attributes[i];if(a.name==="controllerName"){t._controllerName=a.value}else if(a.name==="resourceBundleName"){t._resourceBundleName=a.value}else if(a.name==="resourceBundleUrl"){t._resourceBundleUrl=a.value}else if(a.name==="resourceBundleLocale"){t._resourceBundleLocale=a.value}else if(a.name==="resourceBundleAlias"){t._resourceBundleAlias=a.value}else if(a.name==="class"){t.addStyleClass(a.value)}else if(!n[a.name]&&r[a.name]){n[a.name]=y(r[a.name].type,a.value,a.name,t._oContainingView.oController)}}};T.enrichTemplateIds=function(e,t){T.enrichTemplateIdsPromise(e,t,false);return e};T.enrichTemplateIdsPromise=function(e,t,n){return X(e,t,true,n).then(function(){return e})};T.parseTemplate=function(e,t){return T.parseTemplatePromise(e,t,false).unwrap()};T.parseTemplatePromise=function(e,t,n,r){return X(e,t,false,n,r).then(function(){var e=c.resolve(arguments[0]);if(t.isA("sap.ui.core.Fragment")){return e}var r=arguments;if(t.isA("sap.ui.core.mvc.View")&&t._epInfo&&t._epInfo.all.length>0){e=U(n,t,{content:t._epInfo.all})}return e.then(function(){if(Array.isArray(r[0])){r[0]=r[0].filter(function(e){return e==null||!e._isExtensionPoint})}return r[0]})})};function L(e){var t,n=/^[a-zA-Z_$][a-zA-Z0-9_$]*$/;if(!e||typeof e!=="object"){t="core:require in XMLView can't be parsed to a valid object"}else{Object.keys(e).some(function(r){if(!n.test(r)){t="core:require in XMLView contains invalid identifier: '"+r+"'";return true}if(!e[r]||typeof e[r]!=="string"){t="core:require in XMLView contains invalide value '"+e[r]+"'under key '"+r+"'";return true}})}return t}function O(e,t){var n=e.getAttributeNS(A,"require"),r,i,a;if(n){try{r=w.parseJS(n)}catch(t){p.error("Require attribute can't be parsed on Node: ",e.nodeName);throw t}a=L(r);if(a){throw new Error(a+" on Node: "+e.nodeName)}if(!b(r)){i={};if(t){return new Promise(function(e,t){var n=Object.keys(r).reduce(function(e,t){i[t]=sap.ui.require(r[t]);return e&&i[t]!==undefined},true);if(n){e(i);return}sap.ui.require(g(r),function(){var t=arguments;Object.keys(r).forEach(function(e,n){i[e]=t[n]});e(i)},t)})}else{Object.keys(r).forEach(function(e){i[e]=sap.ui.requireSync(r[e])});return c.resolve(i)}}}}function U(e,t,n){var r=c.resolve();if(!b(n)){var i=[];var a;if(e){r=new Promise(function(e){a=e})}Object.keys(n).forEach(function(e){var r=n[e];r.forEach(function(e){e.targetControl=t;var n=sap.ui.require(e.providerClass);if(n){i.push(n.applyExtensionPoint(e))}else{var r=new Promise(function(t,n){sap.ui.require([e.providerClass],function(e){t(e)},n)}).then(function(t){return t.applyExtensionPoint(e)});i.push(r)}})});if(e){Promise.all(i).then(a)}}return r}function q(e,t,n){var r=n;for(var i=0;i<100;i++){var a=e.lookupNamespaceURI(r);if(a==null||a===t){return r}r=n+i}throw new Error("Could not find an unused namespace prefix after 100 tries, giving up")}function X(t,g,v,h,w){var L=[],X=q(t,P,"__ui5"),j=O(t,h)||c.resolve(),k={openStart:function(e,t){L.push(["openStart",[e,t]])},voidStart:function(e,t){L.push(["voidStart",[e,t]])},style:function(e,t){L.push(["style",[e,t]])},class:function(e){L.push(["class",[e]])},attr:function(e,t){L.push(["attr",[e,t]])},openEnd:function(){L.push(["openEnd"])},voidEnd:function(){L.push(["voidEnd"])},text:function(e){L.push(["text",[e]])},unsafeHtml:function(e){L.push(["unsafeHtml",[e]])},close:function(e){L.push(["close",[e]])},renderControl:function(e){L.push(j)}};h=h&&!!g._sProcessingMode;p.debug("XML processing mode is "+(g._sProcessingMode||"default")+".","","XMLTemplateProcessor");p.debug("XML will be processed "+h?"asynchronously":"synchronously"+".","","XMLTemplateProcessor");var B=sap.ui.getCore().getConfiguration().getDesignMode();if(B){g._sapui_declarativeSourceInfo={xmlNode:t,xmlRootNode:g._oContainingView===g?t:g._oContainingView._sapui_declarativeSourceInfo.xmlRootNode}}var W=g.sViewName||g._sFragmentName;if(!W){var F=g;var D=0;while(++D<1e3&&F&&F!==F._oContainingView){F=F._oContainingView}W=F.sViewName}if(g.isSubView()){Z(t,true,false,j)}else{if(t.localName==="View"&&t.namespaceURI!=="sap.ui.core.mvc"){p.warning("XMLView root node must have the 'sap.ui.core.mvc' namespace, not '"+t.namespaceURI+"'"+(W?" (View name: "+W+")":""))}t.setAttributeNS(x,"xmlns:"+X,P);G(t,false,false,j)}var H=0;function K(){for(;H<L.length;H++){var e=L[H];if(e&&typeof e.then==="function"){return e.then(z).then(K)}}return L}function z(e){var t=[H,1].concat(e);Array.prototype.splice.apply(L,t)}return j.then(K);function $(e){return e}function J(e){return g._oContainingView.createId(e)}function Z(e,t,n,r){if(e.nodeType===1){var i=C(e);var a=e.namespaceURI===_;if(a||e.namespaceURI===I){var o=e.getAttribute("id");if(o==null){o=t===true?g.getId():undefined}else{o=re(g,e)}if(i==="style"){var s=e.attributes;var u=e.textContent;e=document.createElement(i);e.textContent=u;for(var l=0;l<s.length;l++){var f=s[l];if(!f.prefix){e.setAttribute(f.name,f.value)}}if(o!=null){e.setAttribute("id",o)}if(t===true){e.setAttribute("data-sap-ui-preserve",g.getId())}k.unsafeHtml(e.outerHTML);return}var c=E.test(i);if(c){k.voidStart(i,o)}else{k.openStart(i,o)}for(var d=0;d<e.attributes.length;d++){var m=e.attributes[d];if(m.name!=="id"){k.attr(a?m.name.toLowerCase():m.name,m.value)}}if(t===true){k.attr("data-sap-ui-preserve",g.getId())}if(c){k.voidEnd();if(e.firstChild){p.error("Content of void HTML element '"+i+"' will be ignored")}}else{k.openEnd();var v=e instanceof HTMLTemplateElement?e.content:e;G(v,false,false,r);k.close(i)}}else if(i==="FragmentDefinition"&&e.namespaceURI===A){G(e,false,true,r)}else{j=j.then(function(){return ee(e,r).then(function(e){for(var t=0;t<e.length;t++){var n=e[t];if(g.getMetadata().hasAggregation("content")){g._epInfo=g._epInfo||{contentControlsCount:0,last:null,all:[]};if(n._isExtensionPoint){n.index=g._epInfo.contentControlsCount;n.targetControl=g;n.aggregationName="content";if(g._epInfo.last){g._epInfo.last._nextSibling=n}g._epInfo.last=n;g._epInfo.all.push(n)}else{g._epInfo.contentControlsCount++;g.addAggregation("content",n)}}else if(g.getMetadata().hasAssociation("content")){g.addAssociation("content",n)}}return e})});k.renderControl(j)}}else if(e.nodeType===3&&!n){k.text(e.textContent)}}function G(e,t,n,r){var i=e.childNodes;for(var a=0;a<i.length;a++){Z(i[a],t,n,r)}}function Q(t,n){var r;var i=sap.ui.getCore().getLoadedLibraries();e.each(i,function(e,i){if(t===i.namespace||t===i.name){r=i.name+"."+(i.tagNames&&i.tagNames[n]||n)}});r=r||t+"."+n;function a(e){if(!e){p.error("Control '"+r+"' did not return a class definition from sap.ui.define.","","XMLTemplateProcessor");e=d.get(r)}if(!e){p.error("Can't find object class '"+r+"' for XML-view","","XMLTemplateProcessor")}return e}var o=r.replace(/\./g,"/");var s=sap.ui.require(o);if(!s){if(h){return new Promise(function(e,t){sap.ui.require([o],function(t){t=a(t);e(t)},t)})}else{s=sap.ui.requireSync(o);s=a(s)}}return s}function Y(e,t,n){if(e.namespaceURI===_||e.namespaceURI===I){var r=e.attributes["id"]?e.attributes["id"].textContent||e.attributes["id"].text:null;if(v){return T.enrichTemplateIdsPromise(e,g,h).then(function(){return[]})}else{var i=function(t){var n={id:r?re(g,e,r):undefined,xmlNode:e,containingView:g._oContainingView,processingMode:g._sProcessingMode};if(g.fnScopedRunWithOwner){return g.fnScopedRunWithOwner(function(){return new t(n)})}return new t(n)};if(h){return new Promise(function(e,t){sap.ui.require(["sap/ui/core/mvc/XMLView"],function(t){e([i(t)])},t)})}else{var a=sap.ui.requireSync("sap/ui/core/mvc/XMLView");return c.resolve([i(a)])}}}else{return ee(e,t,n)}}function ee(e,t,n){if(C(e)==="ExtensionPoint"&&e.namespaceURI===A){if(v){return c.resolve([])}else{var r=g instanceof a?g._oContainingView:g;var i=l._factory.bind(null,r,e.getAttribute("name"),function(){var r=c.resolve();var i=[];var a=e.childNodes;for(var o=0;o<a.length;o++){var s=a[o];if(s.nodeType===1){r=r.then(Y.bind(null,s,t,n));i.push(r)}}return c.all(i).then(function(e){var t=[];e.forEach(function(e){t=t.concat(e)});return t})},undefined,undefined,h);return c.resolve(g.fnScopedRunWithOwner?g.fnScopedRunWithOwner(i):i())}}else{var o=C(e);var s=o;var u=o.lastIndexOf(".");if(u>=0){s=o.substring(u+1,o.length)}if(/^[a-z].*/.test(s)){var f=g.sViewName||g._sFragmentName||g.getId();p.warning("View or Fragment '"+f+"' contains a Control tag that starts with lower case '"+s+"'",g.getId(),"sap.ui.core.XMLTemplateProcessor#lowerCase")}var d=Q(e.namespaceURI,o);if(d&&typeof d.then==="function"){return d.then(function(r){return te(e,r,t,n)})}else{return te(e,d,t,n)}}}function te(e,t,l,d){var _=e.namespaceURI,x={},I={},E="",L=[],q=null,X=null,j=e.getAttribute("stashed")==="true";if(!v){e.removeAttribute("stashed")}if(!t){return c.resolve([])}var k=t.getMetadata();var W=k.getAllSettings();var F=O(e,h);if(F){l=c.all([l,F]).then(function(e){return Object.assign({},e[0],e[1])})}l=l.then(function(i){if(b(i)){i=null}if(!v){for(var a=0;a<e.attributes.length;a++){var o=e.attributes[a],s=o.name,l=o.namespaceURI,f=W[s],c=o.value;if(s==="id"){x[s]=re(g,e,c)}else if(s==="class"){E+=c}else if(s==="viewName"){x[s]=c}else if(s==="fragmentName"){x[s]=c;x["containingView"]=g._oContainingView}else if(s==="binding"&&!f||s==="objectBindings"){if(!j){var d=n.bindingParser(c,g._oContainingView.oController);if(d){x.objectBindings=x.objectBindings||{};x.objectBindings[d.model||undefined]=d}}}else if(s==="metadataContexts"){if(!j){var h=null;try{h=T._calculatedModelMapping(c,g._oContainingView.oController,true)}catch(e){p.error(g+":"+e.message)}if(h){x.metadataContexts=h;if(T._preprocessMetadataContexts){T._preprocessMetadataContexts(t.getMetadata().getName(),x,g._oContainingView.oController)}}}}else if(s.indexOf(":")>-1){l=o.namespaceURI;if(l===M){var w=C(o);L.push(new r({key:w,value:y("any",c,w,g._oContainingView.oController,i)}))}else if(l===N){X=c}else if(l&&l.startsWith(S)){p.debug(g+": XMLView parser ignored preprocessor attribute '"+s+"' (value: '"+c+"')")}else if(l===P&&C(o)==="invisible"){f=W.visible;if(f&&f._iKind===0&&f.type==="boolean"){x.visible=false}}else if(l===A||l===P||s.startsWith("xmlns:")){}else{if(!q){q={}}if(!q.hasOwnProperty(o.namespaceURI)){q[o.namespaceURI]={}}q[o.namespaceURI][C(o)]=o.nodeValue;p.debug(g+": XMLView parser encountered unknown attribute '"+s+"' (value: '"+c+"') with unknown namespace, stored as sap-ui-custom-settings of customData")}}else if(f&&f._iKind===0){x[s]=y(f.type,c,s,g._oContainingView.oController,i)}else if(f&&f._iKind===1&&f.altTypes){if(!j){x[s]=y(f.altTypes[0],c,s,g._oContainingView.oController,i)}}else if(f&&f._iKind===2){if(!j){var d=n.bindingParser(c,g._oContainingView.oController,false,false,false,false,i);if(d){x[s]=d}else{p.error(g+": aggregations with cardinality 0..n only allow binding paths as attribute value (wrong value: "+s+"='"+c+"')")}}}else if(f&&f._iKind===3){if(!j){x[s]=J(c)}}else if(f&&f._iKind===4){if(!j){x[s]=c.split(/[\s,]+/g).filter($).map(J)}}else if(f&&f._iKind===5){if(!j){var _=[];u.parse(c).forEach(function(e){var t=u.resolveEventHandler(e,g._oContainingView.oController,i);if(t){_.push(t)}else{p.warning(g+': event handler function "'+e+'" is not a function or does not exist in the controller.')}});if(_.length){x[s]=_}}}else if(f&&f._iKind===-1){if(k.isA("sap.ui.core.mvc.View")&&s=="async"){x[s]=y(f.type,c,s,g._oContainingView.oController,i)}else{p.warning(g+": setting '"+s+"' for class "+k.getName()+" (value:'"+c+"') is not supported")}}else{m(s==="xmlns",g+": encountered unknown setting '"+s+"' for class "+k.getName()+" (value:'"+c+"')");if(T._supportInfo){T._supportInfo({context:e,env:{caller:"createRegularControls",error:true,info:"unknown setting '"+s+"' for class "+k.getName()}})}}}if(q){L.push(new r({key:"sap-ui-custom-settings",value:q}))}if(L.length>0){x.customData=L}}return i}).catch(function(t){if(!t.isEnriched){var n=g.getMetadata().isA("sap.ui.core.mvc.View")?"View":"Fragment";var r=e&&e.cloneNode(false).outerHTML;t=new Error("Error found in "+n+" (id: '"+g.getId()+"').\nXML node: '"+r+"':\n"+t);t.isEnriched=true;p.error(t)}if(h&&g._sProcessingMode!==s.SequentialLegacy){throw t}});var D=R(h,H);function H(e,t,n,r,i,a,o){var s,u;if(r.nodeType===1){if(r.namespaceURI===V){x[C(r)]=r.querySelector("*");return}s=r.namespaceURI===_&&n&&n[C(r)];if(s){return D(r,s,false,a,o)}else if(t){if(!i&&r.getAttribute("stashed")==="true"&&!v){var l=r;r=r.cloneNode();l.removeAttribute("stashed");u=function(){var i=re(g,r);f.createStashedControl({wrapperId:i,fnCreate:function(){var r=h;h=false;try{return H(e,t,n,l,true,a,o).unwrap()}finally{h=r}}})};if(g.fnScopedRunWithOwner){g.fnScopedRunWithOwner(u)}else{u()}r.removeAttribute("visible");ne(r,"invisible")}if(x[t.name]&&x[t.name].path&&typeof x[t.name].path==="string"){o={aggregation:t.name,id:x.id}}return Y(r,a,o).then(function(e){for(var n=0;n<e.length;n++){var r=e[n];var i=t.name;if(r._isExtensionPoint){if(!x[i]){x[i]=[]}var a=I[i];if(!a){a=I[i]=[]}r.index=x[i].length;r.aggregationName=i;r.closestAggregationBindingCarrier=o&&o.id;r.closestAggregationBinding=o&&o.aggregation;var s=a[a.length-1];if(s){s._nextSibling=r}a.push(r)}else if(t.multiple){if(!x[i]){x[i]=[]}if(typeof x[i].path==="string"){m(!x[i].template,"list bindings support only a single template object");x[i].template=r}else{x[i].push(r)}}else{m(!x[i],"multiple aggregates defined for aggregation with cardinality 0..1");x[i]=r}}return e})}else if(C(e)!=="FragmentDefinition"||e.namespaceURI!==A){throw new Error("Cannot add direct child without default aggregation defined for control "+k.getElementName())}}else if(r.nodeType===3){var c=r.textContent||r.text;if(c&&c.trim()){throw new Error("Cannot add text nodes as direct child of an aggregation. For adding text to an aggregation, a surrounding html tag is needed: "+c.trim())}}}var K=k.getDefaultAggregation();var z=k.getAllAggregations();return D(e,K,z,l,d).then(function(){var n;var r=c.resolve();var s=c.resolve();var u=e.getAttribute("type");var l=i.getOwnerComponentFor(g);var f=l&&l.isA("sap.ui.core.IAsyncContentCreation");if(v&&e.hasAttribute("id")){ie(g,e)}else if(!v){if(t.getMetadata().isA("sap.ui.core.mvc.View")){var p=function(){if(!t._sType&&!x.viewName){x.viewName="module:"+t.getMetadata().getName().replace(/\./g,"/")}if(f&&h){if(x.async===false){throw new Error("A nested view contained in a Component implementing 'sap.ui.core.IAsyncContentCreation' is processed asynchronously by default and cannot be processed synchronously.\n"+"Affected Component '"+l.getMetadata().getComponentName()+"' and View '"+x.viewName+"'.")}x.type=t._sType||u;s=a.create(x)}else{if(t.getMetadata().isA("sap.ui.core.mvc.XMLView")&&g._sProcessingMode){x.processingMode=g._sProcessingMode}return a._create(x,undefined,t._sType||u)}};if(g.fnScopedRunWithOwner){n=g.fnScopedRunWithOwner(p)}else{n=p()}}else if(t.getMetadata().isA("sap.ui.core.Fragment")&&h){if(u!==o.JS){x.processingMode=g._sProcessingMode}var d="sap/ui/core/Fragment";var m=sap.ui.require(d);x.name=x.name||x.fragmentName;if(m){s=m.load(x)}else{s=new Promise(function(e,t){sap.ui.require([d],function(t){t.load(x).then(function(t){e(t)})},t)})}}else{var b=function(){var e;if(g.fnScopedRunWithOwner){e=g.fnScopedRunWithOwner(function(){var e=new t(x);return e})}else{e=new t(x)}r=U(h,e,I);return e};if(w&&w.fnRunWithPreprocessor){n=w.fnRunWithPreprocessor(b)}else{n=b()}}}return s.then(function(e){return e||n}).then(function(t){if(E&&t.addStyleClass){t.addStyleClass(E)}if(!t){t=[]}else if(!Array.isArray(t)){t=[t]}if(T._supportInfo&&t){for(var n=0,i=t.length;n<i;n++){var a=t[n];if(a&&a.getId()){var o=T._supportInfo({context:e,env:{caller:"createRegularControls",nodeid:e.getAttribute("id"),controlid:a.getId()}}),s=X?X+",":"";s+=o;T._supportInfo.addSupportInfo(a.getId(),s)}}}if(B){t.forEach(function(t){if(k.getCompositeAggregationName){var n=e.getElementsByTagName(t.getMetadata().getCompositeAggregationName());for(var r=0;r<n.length;r++){e.removeChild(n[0])}}t._sapui_declarativeSourceInfo={xmlNode:e,xmlRootNode:g._sapui_declarativeSourceInfo.xmlRootNode,fragmentName:k.getName()==="sap.ui.core.Fragment"?x["fragmentName"]:null}})}return r.then(function(){return t})})})}function ne(e,t){var n=q(e,P,X);e.setAttributeNS(P,n+":"+t,"true")}function re(e,t,n){if(t.getAttributeNS(P,"id")){return t.getAttribute("id")}else{return J(n?n:t.getAttribute("id"))}}function ie(e,t){t.setAttribute("id",J(t.getAttribute("id")));ne(t,"id")}}T._preprocessMetadataContexts=null;T._calculatedModelMapping=function(e,t,r){var i,a={},o=n.bindingParser(e,t);function s(e){if(e.length%2===0){throw new Error("The last entry is no binding")}for(var t=1;t<=e.length;t=t+2){if(typeof e[t-1]=="string"){throw new Error("Binding expected not a string")}if(e[t]){if(typeof e[t]!="string"||e[t]!=","){throw new Error("Missing delimiter ','")}}}}if(o){if(!o.formatter){i=o;o={parts:[i]}}else{s(o.formatter.textFragments)}for(var u=0;u<o.parts.length;u++){i=o.parts[u];a[i.model]=a[i.model]||(r?[]:null);if(Array.isArray(a[i.model])){a[i.model].push(i)}else{a[i.model]=i}}}return a};return T},true);