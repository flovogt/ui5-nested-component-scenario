/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/layout/Grid","./BasePanel","sap/ui/core/ListItem","sap/m/CustomListItem","sap/m/ComboBox","sap/m/List","sap/m/HBox","sap/m/library","sap/m/Button","sap/base/util/merge","sap/ui/core/library"],function(t,e,n,r,i,o,s,a,u,l,h){"use strict";var p=h.ValueState;var g=e.extend("sap.m.p13n.QueryPanel",{metadata:{library:"sap.m",properties:{queryLimit:{type:"int",defaultValue:-1}}},renderer:{apiVersion:2}});var d=a.ListType;var _=a.FlexJustifyContent;var m=a.ButtonType;g.prototype.init=function(){e.prototype.init.apply(this,arguments);this._bFocusOnRearrange=false;this.setEnableReorder(true);this.addStyleClass("sapMP13nQueryPanel")};g.prototype.setP13nData=function(t){e.prototype.setP13nData.apply(this,arguments);this._oListControl.removeAllItems();if(t instanceof Array){t.forEach(function(t){if(t[this.PRESENCE_ATTRIBUTE]){this._addQueryRow(t)}}.bind(this));this._addQueryRow()}return this};g.prototype.getP13nData=function(t){var e=[];this._oListControl.getItems().forEach(function(t){var n=this._getControlFromRow(t)._key;if(n){var r=this._getP13nModel().getProperty("/items").find(function(t){return t.name==n});e.push(r)}}.bind(this));if(!t){this._getP13nModel().getProperty("/items").forEach(function(t){if(e.indexOf(t)===-1){e.push(t)}})}return l([],e)};g.prototype._allEntriesUsed=function(){return this.getP13nData().length===this.getP13nData(true).length};g.prototype._moveTableItem=function(t,e){var n=this._oListControl.getItems().indexOf(t);var r=this._oListControl.getItems().length-1;var i=this.getQueryLimit();if((n!==r||this._allEntriesUsed())&&(i===-1||e<i)){this._oListControl.removeItem(t);this._oListControl.insertItem(t,e);this._updateEnableOfMoveButtons(t,false);this._getP13nModel().checkUpdate(true);this.fireChange({reason:this.CHANGE_REASON_MOVE,item:this._getModelEntry(t)})}};g.prototype._updateEnableOfMoveButtons=function(t,n){e.prototype._updateEnableOfMoveButtons.apply(this,arguments);if(this._oListControl.getItems().indexOf(t)===this._oListControl.getItems().length-2&&!this._allEntriesUsed()){this._getMoveDownButton().setEnabled(false)}};g.prototype._createInnerListControl=function(){return new o(this.getId()+"-innerP13nList",{itemPress:[this._onItemPressed,this],dragDropConfig:this._getDragDropConfig()})};g.prototype._getModelEntry=function(t){var e=this._getControlFromRow(t)._key;var n=this._getP13nModel().getProperty("/items").find(function(t){return t.name==e});return n};g.prototype._getAvailableItems=function(t){var e=this._getP13nModel().getProperty("/items");var r=[];e.forEach(function(t,e){r.push(new n({key:t.name,text:t.label,enabled:{path:this.P13N_MODEL+">/items/"+e+"/"+this.PRESENCE_ATTRIBUTE,formatter:function(t){var e=this.getParent();var n=e.getSelectedItem();var r=n&&e.getItems().indexOf(n);var i=this.getBindingPath("enabled");var o=parseInt(i.split("/")[2]);return!t||r===o}}}))}.bind(this));return r};g.prototype._addQueryRow=function(t){var e=this.getQueryLimit()>-1;var n=this.getQueryLimit()<=this._oListControl.getItems().length;if(e&&n&&!t||this._allEntriesUsed()){return}t=t?t:{name:null};var i=this._createQueryRowGrid(t);var o=new r({type:d.Active,content:[i]});if(this.getEnableReorder()&&(this.getQueryLimit()===-1||this.getQueryLimit()>1&&this._oListControl.getItems().length<this.getQueryLimit())){this._addHover(o)}this._getControlFromRow(o)._key=t.name;this._oListControl.addItem(o);var s=!!t.name;var a=this._createRemoveButton(s);o.getContent()[0].addContent(a);return o};g.prototype._createQueryRowGrid=function(e){var n=this._createKeySelect(e.name);return new t({containerQuery:true,defaultSpan:"XL6 L6 M6 S6",content:[n]}).addStyleClass("sapUiTinyMargin")};g.prototype._handleActivated=function(t){var e=t.getContent()[0];if(e){var n=this._getControlFromRow(t,-1);if(t&&n.getItems().length<2){n.insertItem(this._getMoveUpButton(),0);n.insertItem(this._getMoveDownButton(),1);this._updateEnableOfMoveButtons(t,false)}}};g.prototype._getPlaceholderText=function(){return""};g.prototype._getRemoveButtonTooltipText=function(){return""};g.prototype._createKeySelect=function(t){var e=this;var n=new i({width:"14rem",enabled:{path:this.P13N_MODEL+">/items/",formatter:function(t){if(e.getQueryLimit()<0){return true}var n=e.getP13nData(true).map(function(t){return t.name});var r=this._key;var i=n.indexOf(r)+1;return i<=e.getQueryLimit()}},items:this._getAvailableItems(t),selectedKey:t,placeholder:this._getPlaceholderText(),selectionChange:function(t){var e=t.getSource();var n=e.getSelectedItem();if(!n){this._selectKey(e)}}.bind(this),change:function(t){var e=t.getSource();var n=t.getParameter("newValue");this._selectKey(e);e.setValueState(n&&!e.getSelectedItem()?p.Error:p.None)}.bind(this)});return n};g.prototype._selectKey=function(t){var e=t.getSelectedKey();var n=t._key;var r=t.getParent().getParent();var i=this._oListControl.getItems().length-1==this._oListControl.getItems().indexOf(r);var o=this._getControlFromRow(r,-1);o.setVisible(!(i&&e==""));if(n){this._updatePresence(n,false,undefined)}t._key=e;this._updatePresence(e,true,this._oListControl.getItems().indexOf(r));if(e!==""&&i){this._addQueryRow()}};g.prototype._createRemoveButton=function(t){var e=new s({justifyContent:_.End,width:"100%",visible:t,items:[new u({type:m.Transparent,icon:"sap-icon://decline",press:function(t){var e=t.getSource().getParent().getParent().getParent();var n=this._oListControl.getItems().length;var r=n===1||n==this.getP13nData(true).length;this._oListControl.removeItem(e);this._updatePresence(this._getControlFromRow(e)._key,false,undefined);if(r){this._addQueryRow()}this.getInitialFocusedControl().focus();this._getP13nModel().checkUpdate(true)}.bind(this)})]});if(this._getRemoveButtonTooltipText()){e.getItems()[0].setTooltip(this._getRemoveButtonTooltipText())}return e};g.prototype._moveSelectedItem=function(){this._oSelectedItem=this._getMoveUpButton().getParent().getParent().getParent();e.prototype._moveSelectedItem.apply(this,arguments)};g.prototype._updatePresence=function(t,e,n){var r=l([],this._getP13nModel().getProperty("/items"));var i=r.filter(function(e){return e.name===t});if(i[0]){i[0][this.PRESENCE_ATTRIBUTE]=e}this._getP13nModel().setProperty("/items",r);this.fireChange({reason:e?this.CHANGE_REASON_ADD:this.CHANGE_REASON_REMOVE,item:i[0]})};g.prototype.getInitialFocusedControl=function(){var t=this._getRow(-1);return this._getControlFromRow(t)};g.prototype._getRow=function(t){var e=this._oListControl.getItems();if(t<0){t=e.length+t}return e[t]};g.prototype._getControlFromRow=function(t,e){var n=t.getContent()[0].getContent();if(e===undefined){e=0}if(e<0){e=n.length+e}return n[e]};return g});
//# sourceMappingURL=QueryPanel.js.map