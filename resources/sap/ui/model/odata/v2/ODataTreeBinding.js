/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/assert","sap/base/Log","sap/base/util/deepExtend","sap/base/util/each","sap/base/util/isEmptyObject","sap/ui/model/ChangeReason","sap/ui/model/Context","sap/ui/model/Filter","sap/ui/model/FilterProcessor","sap/ui/model/FilterType","sap/ui/model/Sorter","sap/ui/model/SorterProcessor","sap/ui/model/TreeBinding","sap/ui/model/TreeBindingUtils","sap/ui/model/odata/CountMode","sap/ui/model/odata/ODataUtils","sap/ui/model/odata/OperationMode"],function(e,t,s,i,r,o,a,n,h,l,d,u,f,p,g,c,m){"use strict";var y=f.extend("sap.ui.model.odata.v2.ODataTreeBinding",{constructor:function(e,s,i,r,o,a){f.apply(this,arguments);this.mParameters=this.mParameters||o||{};this.sGroupId=undefined;this.sRefreshGroupId=undefined;this.oFinalLengths={};this.oLengths={};this.oKeys={};this.bNeedsUpdate=false;this._bRootMissing=false;this.bSkipDataEvents=false;if(a instanceof d){a=[a]}this.aSorters=a||[];this.sFilterParams="";this.mNormalizeCache={};r=r||[];if(r instanceof n){r=[r]}if(r.length>1){r=[h.groupFilters(r)]}this.aApplicationFilters=r;this.oModel.checkFilter(this.aApplicationFilters);this.mRequestHandles={};this.oRootContext=null;this.iNumberOfExpandedLevels=o&&o.numberOfExpandedLevels||0;this.iRootLevel=o&&o.rootLevel||0;this.sCountMode=o&&o.countMode||this.oModel.sDefaultCountMode;if(this.sCountMode==g.None){t.fatal("To use an ODataTreeBinding at least one CountMode must be supported by the service!")}if(o){this.sGroupId=o.groupId||o.batchGroupId}this.bInitial=true;this._mLoadedSections={};this._iPageSize=0;this.sOperationMode=o&&o.operationMode||this.oModel.sDefaultOperationMode;if(this.sOperationMode===m.Default){this.sOperationMode=m.Server}this.bClientOperation=this.sOperationMode===m.Client;this.iThreshold=o&&o.threshold||0;this.bThresholdRejected=false;this.iTotalCollectionCount=null;this.bUseServersideApplicationFilters=o&&o.useServersideApplicationFilters||false;this.bUsePreliminaryContext=this.mParameters.usePreliminaryContext||e.bPreliminaryContext;this.oAllKeys=null;this.oAllLengths=null;this.oAllFinalLengths=null;this.bTransitionMessagesOnly=!!this.mParameters.transitionMessagesOnly;this.bRefresh=false;this.iMaximumTopValue=5e3}});y.DRILLSTATES={Collapsed:"collapsed",Expanded:"expanded",Leaf:"leaf"};y.prototype._getHeaders=function(){return this.bTransitionMessagesOnly?{"sap-messages":"transientOnly"}:undefined};y.prototype._getNodeFilterParams=function(e){var t=e.isRoot?this.oTreeProperties["hierarchy-node-for"]:this.oTreeProperties["hierarchy-parent-node-for"];var s=this._getEntityType();return c._createFilterParams(new n(t,"EQ",e.id),this.oModel.oMetadata,s)};y.prototype._getLevelFilterParams=function(e,t){var s=this._getEntityType();return c._createFilterParams(new n(this.oTreeProperties["hierarchy-level-for"],e,t),this.oModel.oMetadata,s)};y.prototype._loadSingleRootNodeByNavigationProperties=function(e,t){var s=this,i;if(this.mRequestHandles[t]){this.mRequestHandles[t].abort()}i=this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId;var r=this.getResolvedPath();if(r){this.mRequestHandles[t]=this.oModel.read(r,{groupId:i,headers:this._getHeaders(),success:function(i){var r=s._getNavPath(s.getPath());if(i){var o=i;var a=s.oModel._getKey(o);var n=s.oModel.getContext("/"+a);s.oRootContext=n;s._processODataObject(n.getObject(),e,r)}else{s._bRootMissing=true}s.bNeedsUpdate=true;delete s.mRequestHandles[t];s.oModel.callAfterUpdate(function(){s.fireDataReceived({data:i})})},error:function(e){if(e&&e.statusCode!=0&&e.statusText!="abort"){s.bNeedsUpdate=true;s._bRootMissing=true;delete s.mRequestHandles[t];s.fireDataReceived()}}})}};y.prototype.getRootContexts=function(e,t,s){var i=null,r={numberOfExpandedLevels:this.iNumberOfExpandedLevels},o=[];if(this.isInitial()){return o}e=e||0;t=t||this.oModel.sizeLimit;s=s||0;var a=""+i+"-"+e+"-"+this._iPageSize+"-"+s;if(this.bHasTreeAnnotations){this.bDisplayRootNode=true;o=this._getContextsForNodeId(null,e,t,s)}else{i=this.getResolvedPath();var n=this.oModel.isList(this.sPath,this.getContext());if(n){this.bDisplayRootNode=true}if(this.bDisplayRootNode&&!n){if(this.oRootContext){return[this.oRootContext]}else if(this._bRootMissing){return[]}else{this._loadSingleRootNodeByNavigationProperties(i,a)}}else{r.navPath=this._getNavPath(this.getPath());if(!this.bDisplayRootNode){i+="/"+r.navPath}o=this._getContextsForNodeId(i,e,t,s,r)}}return o};y.prototype.getNodeContexts=function(e,t,s,i){var r,o={};if(this.isInitial()){return[]}if(this.bHasTreeAnnotations){r=this.oModel.getKey(e);o.level=parseInt(e.getProperty(this.oTreeProperties["hierarchy-level-for"]))+1}else{var a=this._getNavPath(e.getPath());if(!a){return[]}r=this.oModel.resolve(a,e);o.navPath=this.oNavigationPaths[a]}return this._getContextsForNodeId(r,t,s,i,o)};y.prototype.hasChildren=function(e){var s;if(this.bHasTreeAnnotations){if(!e){return false}var i=e.getProperty(this.oTreeProperties["hierarchy-drill-state-for"]);var r=this.oModel.getKey(e);s=this.oLengths[r];if(s===0&&this.oFinalLengths[r]){return false}if(i==="expanded"||i==="collapsed"){return true}else if(i==="leaf"){return false}else{t.warning("The entity '"+e.getPath()+"' has not specified Drilldown State property value.");if(i===undefined||i===""){return true}return false}}else{if(!e){return this.oLengths[this.getPath()]>0}s=this.oLengths[e.getPath()+"/"+this._getNavPath(e.getPath())];return s!==0}};y.prototype.getChildCount=function(e){if(this.bHasTreeAnnotations){var t;if(!e){t=null}else{t=this.oModel.getKey(e)}return this.oLengths[t]}else{if(!e){if(!this.bDisplayRootNode){return this.oLengths[this.getPath()+"/"+this._getNavPath(this.getPath())]}else{return this.oLengths[this.getPath()]}}return this.oLengths[e.getPath()+"/"+this._getNavPath(e.getPath())]}};y.prototype._getContextsForNodeId=function(e,t,s,i,r){var o=[],a;if(this.sOperationMode==m.Auto){if(this.iTotalCollectionCount==null){if(!this.bCollectionCountRequested){this._getCountForCollection();this.bCollectionCountRequested=true}return[]}}t=t||0;s=s||this.oModel.iSizeLimit;i=i||0;if(this.sOperationMode==m.Auto){if(this.iThreshold>=0){i=Math.max(this.iThreshold,i)}}if(!this._mLoadedSections[e]){this._mLoadedSections[e]=[]}if(this.oFinalLengths[e]&&this.oLengths[e]<t+s){s=Math.max(this.oLengths[e]-t,0)}var n=this;var h=function(t){for(var s=0;s<n._mLoadedSections[e].length;s++){var i=n._mLoadedSections[e][s];if(t>=i.startIndex&&t<i.startIndex+i.length){return true}}return false};var l=[];var d=Math.max(t-i-this._iPageSize,0);if(this.oKeys[e]){var u=t+s+i;if(this.oLengths[e]){u=Math.min(u,this.oLengths[e])}for(d;d<u;d++){a=this.oKeys[e][d];if(!a){if(!this.bClientOperation&&!h(d)){l=p.mergeSections(l,{startIndex:d,length:1})}}if(d>=t&&d<t+s){if(a){const e=this.oModel.resolveDeep(this.sPath,this.oContext)+a.slice(a.indexOf("("));o.push(this.oModel.getContext("/"+a,e))}else{o.push(undefined)}}}var f=Math.max(t-i-this._iPageSize,0);var g=t+s+i;var c=l[0]&&l[0].startIndex===f&&l[0].startIndex+l[0].length===g;if(l.length>0&&!c){d=Math.max(l[0].startIndex-i-this._iPageSize,0);var v=l[0].startIndex;for(d;d<v;d++){a=this.oKeys[e][d];if(!a){if(!h(d)){l=p.mergeSections(l,{startIndex:d,length:1})}}}d=l[l.length-1].startIndex+l[l.length-1].length;var P=d+i+this._iPageSize;if(this.oLengths[e]){P=Math.min(P,this.oLengths[e])}for(d;d<P;d++){a=this.oKeys[e][d];if(!a){if(!h(d)){l=p.mergeSections(l,{startIndex:d,length:1})}}}}}else if(!h(t)){var C=t-d;l=p.mergeSections(l,{startIndex:d,length:s+C+i})}if(this.oModel.getServiceMetadata()){if(l.length>0){var _=[];var R="";if(this.bHasTreeAnnotations){if(this.sOperationMode=="Server"||this.bUseServersideApplicationFilters){R=this.getFilterParams()}if(e){R=R?"%20and%20"+R:"";var b=this.oModel.getContext("/"+e);var T=b.getProperty(this.oTreeProperties["hierarchy-node-for"]);var M=this._getNodeFilterParams({id:T});_.push("$filter="+M+R)}else if(e==null){var L="";if(!this.bClientOperation||this.iRootLevel>0){var x=this.bClientOperation?"GE":"EQ";L=this._getLevelFilterParams(x,this.iRootLevel)}if(L||R){if(R&&L){R="%20and%20"+R}_.push("$filter="+L+R)}}}else{R=this.getFilterParams();if(R){_.push("$filter="+R)}}if(this.sCustomParams){_.push(this.sCustomParams)}if(!this.bClientOperation){for(d=0;d<l.length;d++){var F=l[d];this._mLoadedSections[e]=p.mergeSections(this._mLoadedSections[e],{startIndex:F.startIndex,length:F.length});this._loadSubNodes(e,F.startIndex,F.length,0,_,r,F)}}else if(!this.oAllKeys&&!this.mRequestHandles[y.REQUEST_KEY_CLIENT]){this._loadCompleteTreeWithAnnotations(_)}}}return o};y.prototype._getCountForCollection=function(){if(!this.bHasTreeAnnotations||this.sOperationMode!=m.Auto){t.error("The Count for the collection can only be retrieved with Hierarchy Annotations and in OperationMode.Auto.");return}var e=[];function s(e){var t=e.__count?parseInt(e.__count):parseInt(e);this.iTotalCollectionCount=t;if(this.sOperationMode==m.Auto){if(this.iTotalCollectionCount<=this.iThreshold){this.bClientOperation=true;this.bThresholdRejected=false}else{this.bClientOperation=false;this.bThresholdRejected=true}this._fireChange({reason:o.Change})}}function i(e){if(e&&e.statusCode===0&&e.statusText==="abort"){return}var s="Request for $count failed: "+e.message;if(e.response){s+=", "+e.response.statusCode+", "+e.response.statusText+", "+e.response.body}t.warning(s)}var r=this.getResolvedPath();var a="";if(this.iRootLevel>0){a=this._getLevelFilterParams("GE",this.getRootLevel())}var n="";if(this.bUseServersideApplicationFilters){n=this.getFilterParams()}if(a||n){if(n&&a){n="%20and%20"+n}e.push("$filter="+a+n)}let h;const l=this.sCountMode===g.Request||this.sCountMode===g.Both;const d=l?"/$count":"";if(this.sCountMode==g.Inline||this.sCountMode==g.InlineRepeat){e.push("$top=0");e.push("$inlinecount=allpages");h=this._getHeaders()}if(this.sCustomParams4CountRequest&&l){e.push(this.sCustomParams4CountRequest)}if(this.sCustomParams&&!l){e.push(this.sCustomParams)}if(r){this.oModel.read(r+d,{headers:h,urlParameters:e,success:s.bind(this),error:i.bind(this),groupId:this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId})}};y.prototype._getCountForNodeId=function(e){var s=this,i;var r=[];function o(t){s.oFinalLengths[e]=true;s.oLengths[e]=parseInt(t)}function a(e){if(e&&e.statusCode===0&&e.statusText==="abort"){return}var s="Request for $count failed: "+e.message;if(e.response){s+=", "+e.response.statusCode+", "+e.response.statusText+", "+e.response.body}t.warning(s)}var n;var h=this.getFilterParams()||"";var l="";if(this.bHasTreeAnnotations){n=this.getResolvedPath();if(e!=null){const t=this.oModel.getContext("/"+e);const s=t.getProperty(this.oTreeProperties["hierarchy-node-for"]);l=this._getNodeFilterParams({id:s})}else{l=this._getLevelFilterParams("EQ",this.getRootLevel())}}else{n=e}if(l||h){var d="";if(l&&h){d="%20and%20"}h="$filter="+h+d+l;r.push(h)}if(this.sCustomParams4CountRequest){r.push(this.sCustomParams4CountRequest)}if(n){i=this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId;this.oModel.read(n+"/$count",{urlParameters:r,success:o,error:a,sorters:this.aSorters,groupId:i})}};y.prototype._getParentMap=function(e){var s={};for(var i=0;i<e.length;i++){var r=e[i][this.oTreeProperties["hierarchy-node-for"]];if(s[r]){t.warning("ODataTreeBinding: Duplicate key: "+r+"!")}s[r]=this.oModel._getKey(e[i])}return s};y.prototype._createKeyMap=function(e,t){if(e&&e.length>0){var s=this._getParentMap(e),i={};for(var r=t?1:0;r<e.length;r++){var o=e[r][this.oTreeProperties["hierarchy-parent-node-for"]],a=s[o];if(parseInt(e[r][this.oTreeProperties["hierarchy-level-for"]])===this.iRootLevel){a="null"}if(!i[a]){i[a]=[]}i[a].push(this.oModel._getKey(e[r]))}return i}return undefined};y.prototype._importCompleteKeysHierarchy=function(e){var t,s;for(s in e){t=e[s].length||0;this.oKeys[s]=e[s];this.oLengths[s]=t;this.oFinalLengths[s]=true;this._mLoadedSections[s]=[{startIndex:0,length:t}]}};y.prototype._updateNodeKey=function(e,t){var s=this.oModel.getKey(e.context),i,r;if(parseInt(e.context.getProperty(this.oTreeProperties["hierarchy-level-for"]))===this.iRootLevel){i="null"}else{i=this.oModel.getKey(e.parent.context)}r=this.oKeys[i].indexOf(s);if(r!==-1){this.oKeys[i][r]=t}else{this.oKeys[i].push(t)}};y.prototype._loadSubTree=function(e,t){return new Promise(function(s,i){var r,o,a;if(!this.bHasTreeAnnotations){i(new Error("_loadSubTree: doesn't support hierarchies without tree annotations"));return}r="loadSubTree-"+t.join("-");if(this.mRequestHandles[r]){this.mRequestHandles[r].abort()}var n=function(t){if(t.results.length>0){var i=this.oModel.getKey(t.results[0]);this._updateNodeKey(e,i);var o=this._createKeyMap(t.results,true);this._importCompleteKeysHierarchy(o)}delete this.mRequestHandles[r];this.bNeedsUpdate=true;this.oModel.callAfterUpdate(function(){this.fireDataReceived({data:t})}.bind(this));s(t)}.bind(this);var h=function(e){delete this.mRequestHandles[r];if(e&&e.statusCode===0&&e.statusText==="abort"){return}this.fireDataReceived();i()}.bind(this);if(!this.bSkipDataEvents){this.fireDataRequested()}this.bSkipDataEvents=false;a=this.getResolvedPath();if(a){o=this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId;this.mRequestHandles[r]=this.oModel.read(a,{headers:this._getHeaders(),urlParameters:t,success:n,error:h,sorters:this.aSorters,groupId:o})}}.bind(this))};y.prototype._loadSubNodes=function(e,t,s,i,r,o,a){var n=this,h,l=false;if((t||s)&&!this.bClientOperation){r.push("$skip="+t+"&$top="+(s+i))}if(!this.oFinalLengths[e]||this.sCountMode==g.InlineRepeat){if(this.sCountMode==g.Inline||this.sCountMode==g.InlineRepeat||this.sCountMode==g.Both){r.push("$inlinecount=allpages");l=true}else if(this.sCountMode==g.Request){n._getCountForNodeId(e)}}var d=""+e+"-"+t+"-"+this._iPageSize+"-"+i;function u(s){var i,r;if(s){n.oKeys[e]=n.oKeys[e]||[];if(l&&s.__count>=0){n.oLengths[e]=parseInt(s.__count);n.oFinalLengths[e]=true}}if(Array.isArray(s.results)&&s.results.length>0){if(n.bHasTreeAnnotations){var a={};for(r=0;r<s.results.length;r++){i=s.results[r];if(r==0){a[e]=t}else if(a[e]==undefined){a[e]=0}n.oKeys[e][a[e]]=n.oModel._getKey(i);a[e]++}}else{for(r=0;r<s.results.length;r++){i=s.results[r];var h=n.oModel._getKey(i);n._processODataObject(i,"/"+h,o.navPath);n.oKeys[e][r+t]=h}}}else if(s&&!Array.isArray(s.results)){n.oKeys[null]=n.oModel._getKey(s);if(!n.bHasTreeAnnotations){n._processODataObject(s,e,o.navPath)}}delete n.mRequestHandles[d];n.bNeedsUpdate=true;n.oModel.callAfterUpdate(function(){n.fireDataReceived({data:s})})}function f(t){if(t&&t.statusCode===0&&t.statusText==="abort"){return}n.fireDataReceived();delete n.mRequestHandles[d];if(a){var s=[];for(var i=0;i<n._mLoadedSections[e].length;i++){var r=n._mLoadedSections[e][i];if(a.startIndex>=r.startIndex&&a.startIndex+a.length<=r.startIndex+r.length){if(a.startIndex!==r.startIndex&&a.length!==r.length){s=p.mergeSections(s,{startIndex:r.startIndex,length:a.startIndex-r.startIndex});s=p.mergeSections(s,{startIndex:a.startIndex+a.length,length:r.startIndex+r.length-(a.startIndex+a.length)})}}else{s.push(r)}}n._mLoadedSections[e]=s}}if(e!==undefined){if(!this.bSkipDataEvents){this.fireDataRequested()}this.bSkipDataEvents=false;var c;if(this.bHasTreeAnnotations){c=this.getResolvedPath()}else{c=e}if(this.mRequestHandles[d]){this.mRequestHandles[d].abort()}if(c){h=this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId;this.mRequestHandles[d]=this.oModel.read(c,{headers:this._getHeaders(),urlParameters:r,success:u,error:f,sorters:this.aSorters,groupId:h})}}};y.REQUEST_KEY_CLIENT="_OPERATIONMODE_CLIENT_TREE_LOADING";y.prototype._loadCompleteTreeWithAnnotations=function(e,i=[],r=0){var a=this;var n=y.REQUEST_KEY_CLIENT;const h=e.slice();var l=function(e){if(e.results&&e.results.length>0){r+=e.results.length;i.push(e.results);if(e.__next||e.results.length===a.iMaximumTopValue){delete a.mRequestHandles[n];a._loadCompleteTreeWithAnnotations(h,i,r);return}}let o;if(r>0){o=Array.prototype.concat.apply([],i);var l={};var d;for(var u=0;u<o.length;u++){d=o[u];var f=d[a.oTreeProperties["hierarchy-node-for"]];if(l[f]){t.warning("ODataTreeBinding - Duplicate data entry for key: "+f+"!")}l[f]=a.oModel._getKey(d)}for(var p=0;p<o.length;p++){d=o[p];var g=d[a.oTreeProperties["hierarchy-parent-node-for"]];var c=l[g];if(parseInt(d[a.oTreeProperties["hierarchy-level-for"]])===a.iRootLevel){c="null"}a.oKeys[c]=a.oKeys[c]||[];var m=a.oModel._getKey(d);a.oKeys[c].push(m);a.oLengths[c]=a.oLengths[c]||0;a.oLengths[c]++;a.oFinalLengths[c]=true;a._mLoadedSections[c]=a._mLoadedSections[c]||[];a._mLoadedSections[c][0]=a._mLoadedSections[c][0]||{startIndex:0,length:0};a._mLoadedSections[c][0].length++}}else{o=[];a.oKeys["null"]=[];a.oLengths["null"]=0;a.oFinalLengths["null"]=true}a.oAllKeys=s({},a.oKeys);a.oAllLengths=s({},a.oLengths);a.oAllFinalLengths=s({},a.oFinalLengths);delete a.mRequestHandles[n];a.bNeedsUpdate=true;if(a.aApplicationFilters&&a.aApplicationFilters.length>0||a.aFilters&&a.aFilters.length>0){a._applyFilter()}if(a.aSorters&&a.aSorters.length>0){a._applySort()}a.oModel.callAfterUpdate(function(){a.fireDataReceived({data:{results:o}})})};var d=function(e){delete a.mRequestHandles[n];var t=e.statusCode==0;if(!t){a.oKeys={};a.oLengths={};a.oFinalLengths={};a.oAllKeys={};a.oAllLengths={};a.oAllFinalLengths={};a._fireChange({reason:o.Change});a.fireDataReceived()}};if(!this.bSkipDataEvents&&r===0){this.fireDataRequested()}this.bSkipDataEvents=false;if(this.mRequestHandles[n]){this.mRequestHandles[n].abort()}var u=this.getResolvedPath();if(u){if(this.iTotalCollectionCount){e.push("$top="+this.iTotalCollectionCount)}this.mRequestHandles[n]=this.oModel.read(u,{headers:this._getHeaders(),urlParameters:r?["$skip="+r+"&$top="+a.iMaximumTopValue,...h]:e,success:l,error:d,sorters:this.aSorters,groupId:this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId})}};y.prototype.resetData=function(e){var t,s=false;if(typeof e==="boolean"){s=e}else{t=e}if(t){var i=t.getPath();delete this.oKeys[i];delete this.oLengths[i];delete this.oFinalLengths[i];delete this._mLoadedSections[i]}else{this.oKeys={};this.bClientOperation=this.sOperationMode===m.Client;this.bThresholdRejected=false;this.iTotalCollectionCount=null;this.bCollectionCountRequested=false;this.oAllKeys=null;this.oAllLengths=null;this.oAllFinalLengths=null;this.oLengths={};this.oFinalLengths={};this.oRootContext=null;this._bRootMissing=false;if(!s){this._abortPendingRequest()}this._mLoadedSections={};this._iPageSize=0;this.sFilterParams=""}};y.prototype.refresh=function(e,t){if(typeof e==="string"){t=e}this.sRefreshGroupId=t;this._refresh(e);this.sRefreshGroupId=undefined};y.prototype._refresh=function(e,t,s){var i=false;if(!e){if(s){var r=this.getResolvedPath();if(r){if(r.indexOf("?")!==-1){r=r.split("?")[0]}var a=this.oModel.oMetadata._getEntityTypeByPath(r);if(a&&a.entityType in s){i=true}}}if(t&&!i){i=this._isRefreshAfterChangeAllowed()&&this._hasChangedEntity(t)}if(!t&&!s){i=true}}if(e||i){this.resetData();this.bNeedsUpdate=false;this.bRefresh=true;this._fireRefresh({reason:o.Refresh})}};y.prototype._isRefreshAfterChangeAllowed=function(){return true};y.prototype._hasChangedEntity=function(e){var t,s;for(s in this.oKeys){for(t in e){if(this.oKeys[s].includes(t)){return true}}}return false};y.prototype.filter=function(e,i,r){var a=false;i=i||l.Control;this.oModel.checkFilter(e);if(i==l.Control&&(!this.bClientOperation||this.sOperationMode==m.Server)){t.warning("Filtering with ControlFilters is ONLY possible if the ODataTreeBinding is running in OperationMode.Client or "+"OperationMode.Auto, in case the given threshold is lower than the total number of tree nodes.");return this}if(!e){e=[]}if(e instanceof n){e=[e]}if(i===l.Control){this.aFilters=e}else{if(e.length>1){e=[h.groupFilters(e)]}this.aApplicationFilters=e}if(!this.bInitial){if(this.bClientOperation&&(i===l.Control||i===l.Application&&!this.bUseServersideApplicationFilters)){if(this.oAllKeys){this.oKeys=s({},this.oAllKeys);this.oLengths=s({},this.oAllLengths);this.oFinalLengths=s({},this.oAllFinalLengths);this._applyFilter();this._applySort();this._fireChange({reason:o.Filter})}else{this.sChangeReason=o.Filter}}else{this.resetData();this.sChangeReason=o.Filter;this._fireRefresh({reason:this.sChangeReason})}a=true}if(r){return a}else{return this}};y.prototype._applyFilter=function(){var e=this;var s;if(this.bUseServersideApplicationFilters){s=h.groupFilters(this.aFilters)}else{s=h.combineFilters(this.aFilters,this.aApplicationFilters)}var i=function(t){var i=h.apply([t],s,function(t,s){var i=e.oModel.getContext("/"+t);return e.oModel.getProperty(s,i)},e.mNormalizeCache);return i.length>0};var r={};this._filterRecursive({id:"null"},r,i);this.oKeys=r;if(!this.oKeys["null"]){t.warning("Clientside filter did not match on any node!")}else{this.oLengths["null"]=this.oKeys["null"].length;this.oFinalLengths["null"]=true}};y.prototype._filterRecursive=function(e,t,s){var i=this.oKeys[e.id];if(i){e.children=e.children||[];for(var r=0;r<i.length;r++){var o=this._filterRecursive({id:i[r]},t,s);if(o.isFiltered){t[e.id]=t[e.id]||[];t[e.id].push(o.id);e.children.push(o)}}if(e.children.length>0){e.isFiltered=true}else{e.isFiltered=s(e.id)}if(e.isFiltered){this.oLengths[e.id]=e.children.length;this.oFinalLengths[e.id]=true}return e}else{e.isFiltered=s(e.id);return e}};y.prototype.sort=function(e,t){var s=false;if(e instanceof d){e=[e]}this.aSorters=e||[];if(!this.bInitial){this._abortPendingRequest();if(this.bClientOperation){this.addSortComparators(e,this.oEntityType);if(this.oAllKeys){this._applySort();this._fireChange({reason:o.Sort})}else{this.sChangeReason=o.Sort}}else{this.resetData(undefined,{reason:o.Sort});this.sChangeReason=o.Sort;this._fireRefresh({reason:this.sChangeReason})}s=true}if(t){return s}else{return this}};y.prototype.addSortComparators=function(s,r){var o,a;if(!r){t.warning("Cannot determine sort comparators, as entitytype of the collection is unknown!");return}i(s,function(t,s){if(!s.fnCompare){o=this.oModel.oMetadata._getPropertyMetadata(r,s.sPath);a=o&&o.type;e(o,"PropertyType for property "+s.sPath+" of EntityType "+r.name+" not found!");s.fnCompare=c.getComparator(a)}}.bind(this))};y.prototype._applySort=function(){var e=this,t;var s=function(s,i){t=e.oModel.getContext("/"+s);return e.oModel.getProperty(i,t)};for(var i in this.oKeys){u.apply(this.oKeys[i],this.aSorters,s)}};y.prototype.checkUpdate=function(e,t){var s=this.sChangeReason?this.sChangeReason:o.Change;var r=false;if(!e){if(this.bNeedsUpdate||!t){r=true}else{i(this.oKeys,function(e,s){i(s,function(e,s){if(s in t){r=true;return false}return true});if(r){return false}return true})}}if(e||r){this.bNeedsUpdate=false;this._fireChange({reason:s})}this.sChangeReason=undefined};y.prototype._getNavPath=function(e){var t=this.oModel.resolve(e,this.getContext());if(!t){return undefined}var s=t.split("/"),i=s[s.length-1],r;var o=i.split("(")[0];if(o&&this.oNavigationPaths[o]){r=this.oNavigationPaths[o]}return r};y.prototype._processODataObject=function(e,t,s){var i=[],r=this;if(s&&s.indexOf("/")>-1){i=s.split("/");s=i[0];i.splice(0,1)}const o=this.getModel();var a=o._getObject(t);if(Array.isArray(a)){this.oKeys[t]=a;this.oLengths[t]=a.length;this.oFinalLengths[t]=true}else if(a){this.oLengths[t]=1;this.oFinalLengths[t]=true}if(s&&e[s]){if(Array.isArray(a)){a.forEach(function(e){r._processODataObject(o.getProperty("/"+e),"/"+e+"/"+s,i.join("/"))})}else if(typeof a==="object"){r._processODataObject(e,t+"/"+s,i.join("/"))}}};y.prototype._hasTreeAnnotations=function(){var e=this.oModel.oMetadata,s=this.getResolvedPath(),r,o=e.mNamespaces["sap"],a=this;this.oTreeProperties={"hierarchy-level-for":false,"hierarchy-parent-node-for":false,"hierarchy-node-for":false,"hierarchy-drill-state-for":false};var n=function(){var e=0;var s=0;i(a.oTreeProperties,function(t,i){s++;if(i){e+=1}});if(e===s){return true}else if(e>0&&e<s){t.warning("Incomplete hierarchy tree annotations. Please check your service metadata definition!")}return false};if(this.mParameters&&this.mParameters.treeAnnotationProperties){this.oTreeProperties["hierarchy-level-for"]=this.mParameters.treeAnnotationProperties.hierarchyLevelFor;this.oTreeProperties["hierarchy-parent-node-for"]=this.mParameters.treeAnnotationProperties.hierarchyParentNodeFor;this.oTreeProperties["hierarchy-node-for"]=this.mParameters.treeAnnotationProperties.hierarchyNodeFor;this.oTreeProperties["hierarchy-drill-state-for"]=this.mParameters.treeAnnotationProperties.hierarchyDrillStateFor;return n()}if(s.indexOf("?")!==-1){s=s.split("?")[0]}r=e._getEntityTypeByPath(s);if(!r){t.fatal("EntityType for path "+s+" could not be found.");return false}i(r.property,function(e,t){if(!t.extensions){return true}i(t.extensions,function(e,s){var i=s.name;if(s.namespace===o&&i in a.oTreeProperties&&!a.oTreeProperties[i]){a.oTreeProperties[i]=t.name}});return true});return n()};y.prototype.initialize=function(){if(this.oModel.oMetadata&&this.oModel.oMetadata.isLoaded()&&this.bInitial){if(this.isResolved()){this._initialize(this._fireRefresh.bind(this,{reason:o.Refresh}))}else{this._fireRefresh({reason:o.Refresh})}}return this};y.prototype._initialize=function(e){this.bInitial=false;this.bHasTreeAnnotations=this._hasTreeAnnotations();this.oEntityType=this._getEntityType();this._processSelectParameters();this._applyAdapter(e);return this};y.prototype.setContext=function(e){if(e&&e.isPreliminary()&&!this.bUsePreliminaryContext){return}if(e&&e.isUpdated()&&this.bUsePreliminaryContext&&this.oContext===e){this._fireChange({reason:o.Context});return}if(a.hasChanged(this.oContext,e)){this.oContext=e;if(!this.isRelative()){return}if(this.getResolvedPath()){this.resetData();this._initialize(this._fireChange.bind(this,{reason:o.Context}))}else if(!r(this.oAllKeys)||!r(this.oKeys)||!r(this._aNodes)){this.resetData();this._fireChange({reason:o.Context})}}};y.prototype.applyAdapterInterface=function(){this.getContexts=this.getContexts||function(){return[]};this.getNodes=this.getNodes||function(){return[]};this.getLength=this.getLength||function(){return 0};this.isLengthFinal=this.isLengthFinal||function(){return false};this.getContextByIndex=this.getContextByIndex||function(){return};this.attachSelectionChanged=this.attachSelectionChanged||function(e,t,s){this.attachEvent("selectionChanged",e,t,s);return this};this.detachSelectionChanged=this.detachSelectionChanged||function(e,t){this.detachEvent("selectionChanged",e,t);return this};this.fireSelectionChanged=this.fireSelectionChanged||function(e){this.fireEvent("selectionChanged",e);return this};return this};y.prototype._applyAdapter=function(e){var s,r,o,a,n,h,l="sap/ui/model/odata/ODataTreeBindingAdapter",d="hierarchy-node-descendant-count-for",u="hierarchy-preorder-rank-for",f="hierarchy-sibling-rank-for",p=this;if(!this.bHasTreeAnnotations&&!this.oNavigationPaths){t.error("Neither hierarchy annotations, "+"nor navigation properties are specified to build the tree.",this);return}if(this.bHasTreeAnnotations){s=this.getResolvedPath();if(s.indexOf("?")!==-1){s=s.split("?")[0]}r=this.oModel.oMetadata._getEntityTypeByPath(s);i(r.property,function(e,t){if(!t.extensions){return true}i(t.extensions,function(e,s){h=s.name;if(s.namespace===p.oModel.oMetadata.mNamespaces["sap"]&&(h==d||h==f||h==u)){p.oTreeProperties[h]=t.name}});return true});this.oTreeProperties[d]=this.oTreeProperties[d]||this.mParameters.treeAnnotationProperties&&this.mParameters.treeAnnotationProperties.hierarchyNodeDescendantCountFor;if(this.oTreeProperties[d]&&this.sOperationMode==m.Server){this.oTreeProperties[f]=this.oTreeProperties[f]||this.mParameters.treeAnnotationProperties&&this.mParameters.treeAnnotationProperties.hierarchySiblingRankFor;this.oTreeProperties[u]=this.oTreeProperties[u]||this.mParameters.treeAnnotationProperties&&this.mParameters.treeAnnotationProperties.hierarchyPreorderRankFor;if(this.mParameters.restoreTreeStateAfterChange){if(this.oTreeProperties[f]&&this.oTreeProperties[u]){this._bRestoreTreeStateAfterChange=true;this._aTreeKeyProperties=[];for(o=r.key.propertyRef.length-1;o>=0;o--){this._aTreeKeyProperties.push(r.key.propertyRef[o].name)}}else{t.warning("Tree state restoration not possible: Missing annotation "+'"hierarchy-sibling-rank-for" and/or '+'"hierarchy-preorder-rank-for"');this._bRestoreTreeStateAfterChange=false}}else{this._bRestoreTreeStateAfterChange=false}if(this.mParameters&&this.mParameters.select){if(this.mParameters.select.indexOf(this.oTreeProperties[d])===-1){this.mParameters.select+=","+this.oTreeProperties[d]}if(this._bRestoreTreeStateAfterChange){for(a=this._aTreeKeyProperties.length-1;a>=0;a--){n=this._aTreeKeyProperties[a];if(this.mParameters.select.indexOf(n)===-1){this.mParameters.select+=","+n}}}this.sCustomParams=this.oModel.createCustomParams(this.mParameters);this.sCustomParams4CountRequest=this.oModel.createCustomParams(this.mParameters,true)}l="sap/ui/model/odata/ODataTreeBindingFlat"}}sap.ui.require([l],function(t){t.apply(p);e()})};y.prototype._processSelectParameters=function(){if(this.mParameters){this.oNavigationPaths=this.mParameters.navigation;if(this.mParameters.select){var e=this.mParameters.select.split(",");var s=[];if(this.oNavigationPaths){i(this.oNavigationPaths,function(e,t){if(s.indexOf(t)==-1){s.push(t)}})}i(s,function(t,s){if(e.indexOf(s)==-1){e.push(s)}});if(this.bHasTreeAnnotations){i(this.oTreeProperties,function(t,s){if(s){if(e.indexOf(s)==-1){e.push(s)}}})}this.mParameters.select=e.join(",")}this.sCustomParams=this.oModel.createCustomParams(this.mParameters);this.sCustomParams4CountRequest=this.oModel.createCustomParams(this.mParameters,true)}if(!this.bHasTreeAnnotations&&!this.oNavigationPaths){t.error("Neither navigation paths parameters, nor (complete/valid) tree hierarchy annotations where provided to the TreeBinding.");this.oNavigationPaths={}}};y.prototype.getTreeAnnotation=function(e){return this.bHasTreeAnnotations?this.oTreeProperties[e]:undefined};y.prototype.getDownloadUrl=function(e){var t=[],s;if(e){t.push("$format="+encodeURIComponent(e))}if(this.aSorters&&this.aSorters.length>0){t.push(c.createSortParams(this.aSorters))}if(this.getFilterParams()){t.push("$filter="+this.getFilterParams())}if(this.sCustomParams){t.push(this.sCustomParams)}s=this.getResolvedPath();return s&&this.oModel._createRequestUrl(s,null,t)};y.prototype.setNumberOfExpandedLevels=function(e){e=e||0;if(e<0){t.warning("ODataTreeBinding: numberOfExpandedLevels was set to 0. Negative values are prohibited.");e=0}this.iNumberOfExpandedLevels=e;this._fireChange()};y.prototype.getNumberOfExpandedLevels=function(){return this.iNumberOfExpandedLevels};y.prototype.setRootLevel=function(e){e=parseInt(e||0);if(e<0){t.warning("ODataTreeBinding: rootLevels was set to 0. Negative values are prohibited.");e=0}this.iRootLevel=e;this.refresh()};y.prototype.getRootLevel=function(){return parseInt(this.iRootLevel)};y.prototype._getEntityType=function(){var t=this.getResolvedPath();if(t){var s=this.oModel.oMetadata._getEntityTypeByPath(t);e(s,"EntityType for path "+t+" could not be found!");return s}return undefined};y.prototype.getFilterParams=function(){var e;if(this.aApplicationFilters){this.aApplicationFilters=Array.isArray(this.aApplicationFilters)?this.aApplicationFilters:[this.aApplicationFilters];if(this.aApplicationFilters.length>0&&!this.sFilterParams){e=h.groupFilters(this.aApplicationFilters);this.sFilterParams=c._createFilterParams(e,this.oModel.oMetadata,this.oEntityType);this.sFilterParams=this.sFilterParams?"("+this.sFilterParams+")":""}}else{this.sFilterParams=""}return this.sFilterParams};y.prototype.getFilterInfo=function(e){return this.aApplicationFilters[0]?this.aApplicationFilters[0].getAST(e):null};y.prototype._abortPendingRequest=function(){if(!r(this.mRequestHandles)){this.bSkipDataEvents=true;i(this.mRequestHandles,function(e,t){if(t){t.abort()}});this.mRequestHandles={}}};return y});
//# sourceMappingURL=ODataTreeBinding.js.map