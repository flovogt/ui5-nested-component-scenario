/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./Context","./ODataParentBinding","./lib/_Cache","./lib/_GroupLock","./lib/_Helper","sap/ui/base/SyncPromise","sap/ui/model/Binding","sap/ui/model/ChangeReason","sap/ui/model/ContextBinding"],function(e,t,n,o,i,r,a,s,h){"use strict";var u="sap.ui.model.odata.v4.ODataContextBinding",d={AggregatedDataStateChange:true,change:true,dataReceived:true,dataRequested:true,DataStateChange:true,patchCompleted:true,patchSent:true};function c(e,t){var n=e.slice(0,e.lastIndexOf("/")),o=n.indexOf("(");return(o<0?n:e.slice(0,o))+t}var l=h.extend("sap.ui.model.odata.v4.ODataContextBinding",{constructor:function(n,o,r,a){var s=o.indexOf("(...)"),u=this;h.call(this,n,o);t.call(this);if(o.endsWith("/")){throw new Error("Invalid path: "+o)}this.oOperation=undefined;this.oParameterContext=null;this.oReturnValueContext=null;if(s>=0){if(s!==this.sPath.length-5){throw new Error("The path must not continue after a deferred operation: "+this.sPath)}this.oOperation={bAction:undefined,mChangeListeners:{},mParameters:{},sResourcePath:undefined};if(!this.bRelative){this.oParameterContext=e.create(this.oModel,this,this.sPath+"/$Parameter")}}a=i.clone(a)||{};this.checkBindingParameters(a,["$$canonicalPath","$$groupId","$$inheritExpandSelect","$$ownRequest","$$patchWithoutSideEffects","$$updateGroupId"]);this.sGroupId=a.$$groupId;this.bInheritExpandSelect=a.$$inheritExpandSelect;this.sUpdateGroupId=a.$$updateGroupId;this.applyParameters(a);this.oElementContext=this.bRelative?null:e.createNewContext(this.oModel,this,o);if(!this.oOperation&&(!this.bRelative||r&&!r.fetchValue)){this.createReadGroupLock(this.getGroupId(),true)}this.setContext(r);n.bindingCreated(this);Promise.resolve().then(function(){u.bInitial=false})},metadata:{publicMethods:[]}});t(l.prototype);l.prototype._delete=function(e,t,n,o,i){var r=this._findEmptyPathParentContext(this.oElementContext),a=r.getBinding();if(!a.execute){return this.fetchValue("",undefined,true).then(function(t){return r._delete(e,t,i)})}return this.deleteFromCache(e,t,"",null,i,function(){a._destroyContextAfterDelete()})};l.prototype._destroyContextAfterDelete=function(){this.oElementContext.destroy();this.oElementContext=null;if(this.oReturnValueContext){this.oReturnValueContext.destroy();this.oReturnValueContext=null}this._fireChange({reason:s.Remove})};l.prototype._execute=function(t,n,o,a,h){var d=this.oModel.getMetaModel(),l,p,f=this.getResolvedPathWithReplacedTransientPredicates(),g=i.getMetaPath(f),C=this;function m(){C._fireChange({reason:s.Change});return C.refreshDependentBindings("",t.getGroupId(),true)}p=d.fetchObject(g+"/@$ui5.overload").then(function(e){var i,r,s;if(!e){l=d.getObject(g);if(!l||l.$kind!=="NavigationProperty"||!h){throw new Error("Unknown operation: "+f)}}else if(e.length!==1){throw new Error("Expected a single overload, but found "+e.length+" for "+f)}else{l=e[0]}if(C.bRelative&&C.oContext.getBinding){r=C.sPath.lastIndexOf("/");s=r>=0?C.sPath.slice(0,r):"";i=C.oContext.getValue.bind(C.oContext,s)}return C.createCacheAndRequest(t,f,l,n,i,o,a)}).then(function(t){return m().then(function(){var n,o,a,s;if(C.isReturnValueLikeBindingParameter(l)){o=C.oContext.getValue();n=o&&i.getPrivateAnnotation(o,"predicate");a=i.getPrivateAnnotation(t,"predicate");if(n===a){C.oContext.patch(t)}}if(C.hasReturnValueContext(l)){if(C.oReturnValueContext){C.oReturnValueContext.destroy()}if(h){C.oCache=null;C.oCachePromise=r.resolve(null);s=C.oContext.getBinding().doReplaceWith(C.oContext,t,a);s.setNewGeneration();return s}C.oReturnValueContext=e.createNewContext(C.oModel,C,c(f,a));C.oCache.setResourcePath(C.oReturnValueContext.getPath().slice(1));return C.oReturnValueContext}else if(h){throw new Error("Cannot replace w/o return value context")}})},function(e){i.adjustTargetsInError(e,l,C.oParameterContext.getPath(),C.bRelative?C.oContext.getPath():undefined);return m().then(function(){throw e})}).catch(function(e){t.unlock(true);if(C.oReturnValueContext){C.oReturnValueContext.destroy();C.oReturnValueContext=null}C.oModel.reportError("Failed to execute "+f,u,e);throw e});return Promise.resolve(p)};l.prototype.adjustPredicate=function(e,n){t.prototype.adjustPredicate.apply(this,arguments);if(this.mCacheQueryOptions){this.fetchCache(this.oContext,true)}if(this.oElementContext){this.oElementContext.adjustPredicate(e,n)}};l.prototype.applyParameters=function(e,t){this.mQueryOptions=this.oModel.buildQueryOptions(e,true);this.mParameters=e;if(this.isRootBindingSuspended()){if(!this.oOperation){this.sResumeChangeReason=s.Change}}else if(!this.oOperation){this.fetchCache(this.oContext);if(t){this.refreshInternal("",undefined,true).catch(this.oModel.getReporter())}}else if(this.oOperation.bAction===false){this.execute().catch(this.oModel.getReporter())}};l.prototype.attachEvent=function(e,t,n,o){if(!(e in d)){throw new Error("Unsupported event '"+e+"': v4.ODataContextBinding#attachEvent")}return h.prototype.attachEvent.apply(this,arguments)};l.prototype.computeOperationQueryOptions=function(){return Object.assign({},this.oModel.mUriParameters,this.getQueryOptionsFromParameters())};l.prototype.checkKeepAlive=function(){throw new Error("Unsupported "+this)};l.prototype.createCacheAndRequest=function(e,t,o,a,s,h,u){var d=o.$kind==="Action",l,p=s,f=this.oModel,g=i.getMetaPath(t),C=t.slice(1),m=f.oRequestor,x=this;function P(e){if(x.hasReturnValueContext(o)){return c(C,i.getPrivateAnnotation(e,"predicate"))}if(x.isReturnValueLikeBindingParameter(o)&&i.getPrivateAnnotation(p,"predicate")===i.getPrivateAnnotation(e,"predicate")){return C.slice(0,C.lastIndexOf("/"))}return C}function y(e){var t;i.adjustTargetsInError(e,o,x.oParameterContext.getPath(),x.bRelative?x.oContext.getPath():undefined);e.error.$ignoreTopLevel=true;t=u(i.extractMessages(e).map(function(e){return x.oModel.createUI5Message(e)}));if(!(t instanceof Promise)){throw new Error("Not a promise: "+t)}return t}if(u&&o.$kind!=="Action"){throw new Error("Not an action: "+t)}if(!d&&o.$kind!=="Function"&&o.$kind!=="NavigationProperty"){throw new Error("Not an operation: "+t)}if(d&&s){p=s()}if(h&&!(d&&o.$IsBound&&p)){throw new Error("Not a bound action: "+t)}if(this.bInheritExpandSelect&&!this.isReturnValueLikeBindingParameter(o)){throw new Error("Must not set parameter $$inheritExpandSelect on this binding")}if(o.$kind!=="NavigationProperty"){g+="/@$ui5.overload/0/$ReturnType";if(o.$ReturnType&&!o.$ReturnType.$Type.startsWith("Edm.")){g+="/$Type"}}else if(Object.keys(a).length){throw new Error("Unsupported parameters for navigation property")}this.oOperation.bAction=d;this.oOperation.mRefreshParameters=a;a=Object.assign({},a);this.mCacheQueryOptions=this.computeOperationQueryOptions();t=m.getPathAndAddQueryOptions(t,o,a,this.mCacheQueryOptions,p);l=n.createSingle(m,t,this.mCacheQueryOptions,f.bAutoExpandSelect,f.bSharedRequests,P,d,g);this.oCache=l;this.oCachePromise=r.resolve(l);return d?l.post(e,a,p,h,u&&y):l.fetchValue(e)};l.prototype.destroy=function(){if(this.oElementContext){this.oElementContext.destroy();this.oElementContext=undefined}if(this.oParameterContext){this.oParameterContext.destroy();this.oParameterContext=undefined}if(this.oReturnValueContext){this.oReturnValueContext.destroy();this.oReturnValueContext=undefined}this.oModel.bindingDestroyed(this);this.oOperation=undefined;this.mParameters=undefined;this.mQueryOptions=undefined;t.prototype.destroy.call(this);h.prototype.destroy.call(this)};l.prototype.doCreateCache=function(e,t,o,i){return n.createSingle(this.oModel.oRequestor,e,t,this.oModel.bAutoExpandSelect,this.oModel.bSharedRequests,function(){return i})};l.prototype.doDeregisterChangeListener=function(e,n){if(this.oOperation&&(e==="$Parameter"||e.startsWith("$Parameter/"))){i.removeByPath(this.oOperation.mChangeListeners,e.slice(11),n);return}t.prototype.doDeregisterChangeListener.apply(this,arguments)};l.prototype.doFetchQueryOptions=function(e){return this.fetchResolvedQueryOptions(e)};l.prototype.doSetProperty=function(e,t,o){if(this.oOperation&&(e==="$Parameter"||e.startsWith("$Parameter/"))){i.updateAll(this.oOperation.mChangeListeners,"",this.oOperation.mParameters,n.makeUpdateData(e.split("/").slice(1),t));this.oOperation.bAction=undefined;if(o){o.unlock()}return r.resolve()}};l.prototype.doSuspend=function(){if(this.bInitial&&!this.oOperation){this.sResumeChangeReason=s.Change}};l.prototype.execute=function(e,t,n,o){var r=this.getResolvedPath();this.checkSuspended();this.oModel.checkGroupId(e);if(!this.oOperation){throw new Error("The binding must be deferred: "+this.sPath)}if(this.bRelative){if(!r){throw new Error("Unresolved binding: "+this.sPath)}if(this.oContext.isTransient&&this.oContext.isTransient()){throw new Error("Execute for transient context not allowed: "+r)}if(this.oContext.getPath().includes("(...)")){throw new Error("Nested deferred operation bindings not supported: "+r)}if(o){if(!this.oContext.getBinding||this.oContext.iIndex===undefined){throw new Error("Cannot replace this parent context: "+this.oContext)}this.oContext.getBinding().checkKeepAlive(this.oContext)}}else if(o){throw new Error("Cannot replace when operation is not relative")}return this._execute(this.lockGroup(e,true),i.publicClone(this.oOperation.mParameters,true),t,n,o)};l.prototype.fetchValue=function(e,t,n){var a=n&&this.oCache!==undefined?r.resolve(this.oCache):this.oCachePromise,s,h=this.getRootBinding(),d=this;if(h&&h.isSuspended()){s=new Error("Suspended binding provides no value");s.canceled="noDebugLog";throw s}return a.then(function(r){var a=false,s,h=d.getResolvedPath(),c=r||d.oOperation?d.getRelativePath(e):undefined,l,p;if(d.oOperation){if(c===undefined){return d.oContext.fetchValue(e,t,n)}l=c.split("/");if(l[0]==="$Parameter"){if(l.length===1){return undefined}i.addByPath(d.oOperation.mChangeListeners,c.slice(11),t);p=i.drillDown(d.oOperation.mParameters,l.slice(1));return p===undefined?null:p}}if(r&&c!==undefined){if(n){s=o.$cached}else{s=d.oReadGroupLock||d.lockGroup();d.oReadGroupLock=undefined}return d.resolveRefreshPromise(r.fetchValue(s,c,function(){a=true;d.fireDataRequested()},t)).then(function(e){d.assertSameCache(r);return e}).then(function(e){if(a){d.fireDataReceived({data:{}})}return e},function(e){s.unlock(true);if(a){d.oModel.reportError("Failed to read path "+h,u,e);d.fireDataReceived(e.canceled?{data:{}}:{error:e})}throw e})}if(!d.oOperation&&d.oContext){return d.oContext.fetchValue(e,t,n)}})};l.prototype.getDependentBindings=function(){return this.oModel.getDependentBindings(this)};l.prototype.getParameterContext=function(){if(!this.oOperation){throw new Error("Not a deferred operation binding: "+this)}return this.oParameterContext};l.prototype.getQueryOptionsFromParameters=function(){var e,t=this.mQueryOptions;if(this.bInheritExpandSelect){e=this.oContext.getBinding().getInheritableQueryOptions();t=Object.assign({},t);if("$select"in e){t.$select=t.$select&&t.$select.slice();i.addToSelect(t,e.$select)}if("$expand"in e){t.$expand=e.$expand}}return t};l.prototype.getResolvedPathWithReplacedTransientPredicates=function(){var e="",t=this.getResolvedPath(),n,o=this;if(t&&t.includes("($uid=")){n=t.slice(1).split("/");t="";n.forEach(function(n){var r,a,s;e+="/"+n;s=n.indexOf("($uid=");if(s>=0){r=o.oContext.getValue(e);a=r&&i.getPrivateAnnotation(r,"predicate");if(!a){throw new Error("No key predicate known at "+e)}t+="/"+n.slice(0,s)+a}else{t+="/"+n}})}return t};l.prototype.hasReturnValueContext=function(e){var t;if(!this.isReturnValueLikeBindingParameter(e)){return false}t=i.getMetaPath(this.getResolvedPath()).split("/");return t.length===3&&this.oModel.getMetaModel().getObject("/"+t[1]).$kind==="EntitySet"};l.prototype.initialize=function(){this.bInitial=false;if(this.isResolved()&&!this.getRootBinding().isSuspended()){this._fireChange({reason:s.Change})}};l.prototype.isReturnValueLikeBindingParameter=function(e){var t,n;if(!(this.bRelative&&this.oContext&&this.oContext.getBinding)){return false}if(e.$kind==="NavigationProperty"){if(e.$isCollection||this.sPath.includes("/")){return false}n=i.getMetaPath(this.oContext.getPath());if(n.lastIndexOf("/")>0){return false}t=this.oModel.getMetaModel().getObject(n);return t.$kind==="EntitySet"&&t.$Type===e.$Type&&t.$NavigationPropertyBinding&&t.$NavigationPropertyBinding[this.sPath.slice(0,-5)]===n.slice(1)}return e.$IsBound&&e.$ReturnType&&!e.$ReturnType.$isCollection&&e.$EntitySetPath&&!e.$EntitySetPath.includes("/")};l.prototype.moveEntityTo=function(e){if(!this.isRoot()){throw new Error(this+": must be a root binding")}if(this.oOperation){throw new Error(this+": must not be an operation binding")}if(this.hasPendingChanges()){throw new Error(this+": has pending changes")}e.moveEntityHere(this.oElementContext);this.oElementContext=null};l.prototype.refreshInternal=function(t,n,o,i){var a=this;if(this.oOperation&&this.oOperation.bAction!==false){return r.resolve()}if(this.isRootBindingSuspended()){this.refreshSuspended(n);return this.refreshDependentBindings(t,n,o,i)}this.createReadGroupLock(n,this.isRoot());return this.oCachePromise.then(function(h){var u,d=a.oRefreshPromise,c=a.oReadGroupLock;if(!a.oElementContext){a.oElementContext=e.create(a.oModel,a,a.getResolvedPath());if(!h){a._fireChange({reason:s.Refresh})}}if(a.oOperation){a.oReadGroupLock=undefined;return a._execute(c,a.oOperation.mRefreshParameters)}if(h&&!d){u=h.hasChangeListeners();a.removeCachesAndMessages(t);a.fetchCache(a.oContext,false,false,i);d=u?a.createRefreshPromise():undefined;if(i&&d){d=d.catch(function(e){return a.fetchResourcePath(a.oContext).then(function(e){if(!a.bRelative||h.getResourcePath()===e){a.oCache=h;a.oCachePromise=r.resolve(h);h.setActive(true);return a.checkUpdateInternal()}}).then(function(){throw e})})}if(!o){a.fetchValue("").catch(a.oModel.getReporter())}}return r.all([d,a.refreshDependentBindings(t,n,o,i)])})};l.prototype.refreshReturnValueContext=function(e,t,o){var a=this.oCache,s=this.mCacheQueryOptions,h=this.oModel,u,d=this;if(this.oReturnValueContext!==e){return null}this.mCacheQueryOptions=this.computeOperationQueryOptions();if(this.mLateQueryOptions){i.aggregateExpandSelect(this.mCacheQueryOptions,this.mLateQueryOptions)}this.oCache=n.createSingle(h.oRequestor,e.getPath().slice(1),this.mCacheQueryOptions,true,h.bSharedRequests);this.oCachePromise=r.resolve(this.oCache);this.createReadGroupLock(t,true);u=e.refreshDependentBindings("",t,true,o);if(o){u=u.catch(function(t){d.oCache=a;d.oCachePromise=r.resolve(a);d.mCacheQueryOptions=s;a.setActive(true);return e.checkUpdateInternal().then(function(){throw t})})}return u};l.prototype.requestSideEffects=function(e,t,n){var o=this.oModel,i={},a=[],s=this;function h(e){return e.catch(function(e){o.reportError("Failed to request side effects",u,e);if(!e.canceled){throw e}})}if(t.indexOf("")<0){try{a.push(this.oCache.requestSideEffects(this.lockGroup(e),t,i,n&&n.getPath().slice(1)));this.visitSideEffects(e,t,n,i,a);return r.all(a.map(h)).then(function(){return s.refreshDependentListBindingsWithoutCache()})}catch(e){if(!e.message.startsWith("Unsupported collection-valued navigation property ")){throw e}}}return n&&this.refreshReturnValueContext(n,e,true)||this.refreshInternal("",e,true,true)};l.prototype.requestObject=function(e){return this.oElementContext?this.oElementContext.requestObject(e):Promise.resolve()};l.prototype.resumeInternal=function(e,t){var n=this.sResumeChangeReason,o=this;function i(){o.getDependentBindings().forEach(function(t){t.resumeInternal(e,!!n)})}this.sResumeChangeReason=undefined;if(this.oOperation){i();return}if(t||n){this.mAggregatedQueryOptions={};this.bAggregatedQueryOptionsInitial=true;this.removeCachesAndMessages("");this.fetchCache(this.oContext)}i();if(n){this._fireChange({reason:n})}};l.prototype.setContext=function(t){if(this.oContext!==t){if(this.bRelative&&(this.oContext||t)){this.checkSuspended(true);if(this.oElementContext){this.oElementContext.destroy();this.oElementContext=null}if(this.oReturnValueContext){this.oReturnValueContext.destroy();this.oReturnValueContext=null}if(this.oParameterContext){this.oParameterContext.destroy();this.oParameterContext=null}this.fetchCache(t);if(t){this.oElementContext=e.create(this.oModel,this,this.oModel.resolve(this.sPath,t));if(this.oOperation){this.oParameterContext=e.create(this.oModel,this,this.oModel.resolve(this.sPath+"/$Parameter",t))}}a.prototype.setContext.call(this,t)}else{this.oContext=t}}};l.prototype.setParameter=function(e,t){var n;if(!this.oOperation){throw new Error("The binding must be deferred: "+this.sPath)}if(!e){throw new Error("Missing parameter name")}if(t===undefined){throw new Error("Missing value for parameter: "+e)}n=this.oOperation.mParameters[e];this.oOperation.mParameters[e]=t;i.informAll(this.oOperation.mChangeListeners,e,n,t);this.oOperation.bAction=undefined;return this};return l});