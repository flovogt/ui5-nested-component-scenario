/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/ResponsivePopover","sap/m/Button","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/library","sap/ui/Device","sap/ui/core/Control","sap/ui/core/Core","sap/ui/core/Element","sap/ui/core/library","sap/ui/core/UIArea","sap/ui/thirdparty/jquery","sap/ui/dom/containsOrEquals","sap/ui/events/ControlEvents","sap/base/strings/capitalize","sap/m/p13n/AbstractContainerItem","sap/m/p13n/Container","sap/m/table/columnmenu/MenuRenderer","sap/ui/layout/form/Form","sap/ui/layout/GridData","sap/ui/layout/form/ResponsiveGridLayout","sap/ui/layout/form/FormContainer","sap/ui/layout/form/FormElement","sap/m/Label"],function(e,t,i,o,n,r,s,a,u,l,c,jQuery,p,f,h,g,d,m,_,v,y,C,I,b){"use strict";var A=l.aria.HasPopup;var E=l.VerticalAlign;var w=n.table.columnmenu.Category;var P=s.extend("sap.m.table.columnmenu.Menu",{metadata:{library:"sap.m",interfaces:["sap.ui.core.IColumnHeaderMenu"],aggregations:{quickActions:{type:"sap.m.table.columnmenu.QuickActionBase"},items:{type:"sap.m.table.columnmenu.ItemBase"},_quickActions:{type:"sap.m.table.columnmenu.QuickActionBase",visibility:"hidden"},_items:{type:"sap.m.table.columnmenu.ItemBase",visibility:"hidden"}},events:{beforeOpen:{parameters:{openBy:{type:"sap.ui.core.Element"}}}}},renderer:m});var B="$default";var L=A.Dialog;P.prototype.init=function(){this.fAnyEventHandlerProxy=jQuery.proxy(function(e){if(!this.isOpen()||!this.getDomRef()||e.type!="mousedown"&&e.type!="touchstart"){return}this.handleOuterEvent(this.getId(),e)},this)};P.prototype.applySettings=function(e){if(e){this._addAllToPrivateAggregation(e,"_quickActions");this._addAllToPrivateAggregation(e,"_items")}s.prototype.applySettings.apply(this,arguments)};P.prototype.openBy=function(e){if(this.isOpen()&&e===this._oIsOpenBy){return}var t=e;if(!(e instanceof u)){t=u.closestTo(e,true)}this.fireBeforeOpen({openBy:t});this._initPopover();this._createQuickActionGrids();if(this._oItemsContainer){this._oItemsContainer.destroy();this._oItemsContainer=null}this._initItemsContainer();if(!this.getParent()){c.registry.get(a.getStaticAreaRef().id).addContent(this,true)}this._oPopover.openBy(e);this._oIsOpenBy=e;f.bindAnyEvent(this.fAnyEventHandlerProxy)};P.prototype.getAriaHasPopupType=function(){return L};P.prototype.isOpen=function(){return this._oPopover?this._oPopover.isOpen():false};P.prototype.close=function(){this._previousView=null;if(this._oPopover&&this._oPopover.isOpen()){this._oPopover.close();f.unbindAnyEvent(this.fAnyEventHandlerProxy)}};P.prototype.exit=function(){s.prototype.exit.apply(this,arguments);if(this._oPopover){delete this._oPopover}if(this._oItemsContainer){delete this._oItemsContainer}if(this._oIsOpenBy){delete this._oIsOpenBy}f.unbindAnyEvent(this.fAnyEventHandlerProxy)};P.prototype._addAllToPrivateAggregation=function(e,t){if(e[t]){e[t].forEach(function(e){this.addAggregation(t,e)}.bind(this));delete e[t]}};P.prototype._initPopover=function(){if(this._oPopover){return}this._oPopover=new e({title:this._getResourceText("table.COLUMNMENU_TITLE"),ariaLabelledBy:this.getId()+"-menuDescription",showArrow:false,showHeader:r.system.phone,placement:n.PlacementType.Bottom,content:new S({control:this,height:true}),horizontalScrolling:false,verticalScrolling:false,afterClose:[this.close,this]});this.addDependent(this._oPopover);this._oPopover.addStyleClass("sapMTCMenuPopup");this._oPopover.addEventDelegate({onAfterRendering:this._focusItem},this);if(this._getAllEffectiveItems().length===0){this._oPopover.attachAfterOpen(this._focusInitialQuickAction.bind(this))}else{this._oPopover.attachAfterOpen(function(){var e=this._oItemsContainer._getNavigationList().getItems().find(function(e){return e.getVisible()});e&&e.focus()}.bind(this))}this._oPopover._oControl.oPopup.setAutoClose(false)};P.prototype.onsapfocusleave=function(e){if(!this.isOpen()){return}this.handleOuterEvent(this.getId(),e)};P.prototype.handleOuterEvent=function(e,t){var i=false,o=r.support.touch||r.system.combi;if(t.type=="mousedown"||t.type=="touchstart"){if(o&&(t.isMarked("delayedMouseEvent")||t.isMarked("cancelAutoClose"))){return}if(p(this.getDomRef(),t.target)||p(a.getStaticAreaRef(),t.target)||k(this,a.byId(t.target.id))){i=true}}else if(t.type=="sapfocusleave"){if(o){return}if(t.relatedControlId){if(p(this.getDomRef(),jQuery(document.getElementById(t.relatedControlId)).get(0))||k(this,a.byId(t.relatedControlId))){i=true}}}if(!i){this.close()}};function k(e,t){if(!e||!t){return false}var i=t.getParent();if(!i){return false}else if(i===e){return true}return k(e,i)}P.prototype._initItemsContainer=function(){var e=this._getAllEffectiveItems();var t=this._hasQuickActions();var i=this._hasItems();if(!this._oItemsContainer){this._createItemsContainer()}e.forEach(function(e,o){this._addView(e);if(t&&i&&o===0){this._oItemsContainer.addSeparator()}}.bind(this))};var S=s.extend("sap.m.table.columnmenu.AssociativeControl",{metadata:{final:true,properties:{height:{type:"boolean",defaultValue:false}},associations:{control:{type:"sap.ui.core.Control"}}},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t);t.getHeight()&&e.style("height","100%");e.openEnd();e.renderControl(sap.ui.getCore().byId(t.getControl()));e.close("div")}}});P.prototype._addView=function(e){var t=new g({content:new S({control:e.getContent(),height:true}),key:e.getId(),text:e.getLabel(),icon:e.getIcon()});this._oItemsContainer.addView(t);this._setItemVisibility(e,e.getVisible())};P.prototype._createItemsContainer=function(){var e=this;this._oBtnCancel=new t({text:this._getResourceText("table.COLUMNMENU_CANCEL"),press:function(){var t=e._oItemsContainer.getCurrentViewKey();if(e._fireEvent(a.byId(t),"cancel")){e.close()}}});this._oBtnOk=new t({text:this._getResourceText("table.COLUMNMENU_CONFIRM"),type:n.ButtonType.Emphasized,press:function(){var t=e._oItemsContainer.getCurrentViewKey();if(e._fireEvent(a.byId(t),"confirm")){e.close()}}});e._oItemsContainer=new d({listLayout:true,defaultView:B,footer:new i({content:[new o,this._oBtnOk,this._oBtnCancel]}),beforeViewSwitch:function(t){var i=t.getParameters();if(i.target!=="$default"){var o=e._oItemsContainer.getView(i.target);var n=e._getItemFromContainerItem(o);if(n&&!e._fireEvent(n,"press")){t.preventDefault()}}},afterViewSwitch:function(t){var i=t.getParameters();this.oLayout.setShowFooter(i.target!=="$default");e._previousView=i.source;if(i.target!=="$default"){var o=e._oItemsContainer.getView(i.target);if(o){var n=e._getItemFromContainerItem(o);e._updateButtonState(n);e._focusItem()}}else{e._focusItem();this._oPopover&&this._oPopover.invalidate()}}});e._oItemsContainer.getHeader().addContentRight(new t({text:this._getResourceText("table.COLUMNMENU_RESET"),press:function(){e._fireEvent(a.byId(e._oItemsContainer.getCurrentViewKey()),"reset",false)}}));this._oPopover.addDependent(e._oItemsContainer);e.addDependent(e._oItemsContainer)};P.prototype._fireEvent=function(e,t,i){var o=e["on"+h(t)];if(i!==false){var n=jQuery.Event(t);o.call(e,n);return!n.isDefaultPrevented()}else{o.call(e);return true}};P.prototype._getResourceText=function(e,t){this.oResourceBundle=this.oResourceBundle?this.oResourceBundle:sap.ui.getCore().getLibraryResourceBundle("sap.m");return e?this.oResourceBundle.getText(e,t):this.oResourceBundle};var V={};V[w.Sort]=0;V[w.Filter]=1;V[w.Group]=2;V[w.Aggregate]=3;V[w.Generic]=4;P.prototype._getAllEffectiveQuickActions=function(e){var t=(this.getAggregation("_quickActions")||[]).concat(this.getQuickActions());t=t.reduce(function(e,t){return e.concat(t?t.getEffectiveQuickActions():[])},[]);if(!e){t.sort(function(e,t){return V[e.getCategory()]-V[t.getCategory()]})}return t};P.prototype._hasQuickActions=function(){return this._getAllEffectiveQuickActions(true).length>0};P.prototype._getAllEffectiveItems=function(){var e=(this.getAggregation("_items")||[]).concat(this.getItems());return e.reduce(function(e,t){return e.concat(t.getEffectiveItems())},[]).filter(function(e){return e.getVisible()})};P.prototype._hasItems=function(){return this._getAllEffectiveItems().length>0};P.prototype._getItemFromContainerItem=function(e){return this._getAllEffectiveItems().find(function(t){return t.getId()===e.getKey()})};P.prototype._updateButtonState=function(e){if(!this._oItemsContainer){return}if(this._oItemsContainer.getCurrentViewKey()===B){return}this._oItemsContainer.getHeader().getContentRight()[0].setVisible(e.getButtonSettings()["reset"]["visible"]);this._oItemsContainer.getHeader().getContentRight()[0].setEnabled(e.getButtonSettings()["reset"]["enabled"]);this._oBtnOk.setVisible(e.getButtonSettings()["confirm"]["visible"]);this._oBtnCancel.setVisible(e.getButtonSettings()["cancel"]["visible"])};P.prototype._focusItem=function(){if(this._previousView==B){this._oItemsContainer._getNavBackBtn().focus()}else{var e=this._oItemsContainer._getNavigationList().getItems().find(function(e){return e.getVisible()&&e._key===this._previousView}.bind(this));e&&e.focus()}};P.prototype._focusInitialQuickAction=function(){var e=[];if(this.getAggregation("_quickActions")){e=this.getAggregation("_quickActions")[0].getEffectiveQuickActions()}else if(this.getQuickActions().length>0){e=this.getQuickActions()[0].getEffectiveQuickActions()}e.length>0&&e[0].getContent()[0].focus()};P.prototype._setItemVisibility=function(e,t){var i=this._oItemsContainer._getNavigationList().getItems();var o=i.find(function(t){return t._key==e.getId()});o&&o.setVisible(t)};P.prototype._createQuickActionGrids=function(){var e;if(this._oForm){e=this._oForm.getFormContainers()[0];e.destroyFormElements()}else{e=new C;this._oForm=new _({layout:new y({breakpointM:600,labelSpanXL:4,labelSpanL:4,labelSpanM:4,labelSpanS:12,columnsL:1,columnsM:1,adjustLabelSpan:false}),editable:true,formContainers:e});this._oForm.addStyleClass("sapMTCMenuQAForm");this._oForm.addEventDelegate({onAfterRendering:function(){this.getDomRef().classList.remove("sapUiFormLblColon")}},this._oForm)}this._getAllEffectiveQuickActions().forEach(function(t){if(!t.getVisible()){return}var i=new v({span:"XL4 L4 M4 S12"});var o=t.getLabel();var n=new b({text:o,layoutData:i,vAlign:E.Middle,wrapping:true,width:"100%",showColon:o!==""&&!(t.getParent()&&t.getParent().isA("sap.m.table.columnmenu.QuickSortItem"))&&t._bHideLabelColon!==true});n.addStyleClass("sapMTCMenuQALabel");var r=[];var s=t.getContent()||[];s.forEach(function(e,t){var i,o,a,u;if(e.getLayoutData()){i=e.getLayoutData().clone()}else{o="L8 M8 S12";a="";if(t>0||t==0&&s.length>1){o="L4 M4 S6";if(t!=0&&(t+1)%2>0){a="L4 M4 S0"}}i=new v({span:o,indent:a})}e.removeAllAssociation("ariaLabelledBy");e.addAssociation("ariaLabelledBy",n.getId());u=new S({control:e.setWidth("100%")});u.setLayoutData(i);r.push(u)},this);e.addFormElement(new I({label:n,fields:r}))},this);this.addDependent(this._oForm)};return P});
//# sourceMappingURL=Menu.js.map