/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/i18n/LanguageFallback","sap/base/i18n/Localization","sap/ui/Device","sap/ui/core/Element","sap/ui/core/LabelEnablement","sap/ui/core/Lib","sap/ui/util/XMLHelper"],function(t,e,n,o,r,s,i,a){"use strict";const c="sap.ui.interaction.UpdateDisplay";const l="1.0.0";const u={_version:l,elements:[],docs:{}};const f=new Map;const d=t=>{const e=t.split("+").map(t=>t.trim());const n={ctrl:false,alt:false,shift:false};let r=null;for(const t of e){const e=t.toLowerCase();if(e==="ctrl"){n.ctrl=true}else if(e==="alt"){n.alt=true}else if(e==="shift"){n.shift=true}else if(!r){if(t.length===1){r=t.toUpperCase()}else{r=t}}}const s=[];if(n.ctrl){s.push(o.os.macintosh?"Cmd":"Ctrl")}if(n.alt){s.push("Alt")}if(n.shift){s.push("Shift")}if(r){s.push(r)}return s.join("+")};const g=t=>{const e=i.getResourceBundleFor("sap.ui.core");return t.split("+").map(t=>{const n=`Keyboard.Shortcut.${t.trim()}`;const o=e.getText(n);return o===n?t.trim():o}).join("+")};const m=t=>{const e=t.querySelectorAll("kbd");e.forEach(t=>{const e=d(t.textContent.trim());const n=g(e);t.setAttribute("data-sap-ui-kbd-raw",e);t.textContent=n});return t};const p=t=>{const e=[];const n=t.getDependents?.()||[];for(const t of n){if(t.isA("sap.ui.core.CommandExecution")&&t.getVisible()){const n=t._getCommandInfo();const o=d(n.shortcut);e.push({name:t.getCommand(),kbd:[{raw:o,translated:g(o)}],description:n.description})}}return e};const h=(t,e)=>{const n=t.getFieldHelpDisplay();const o=n?r.getElementById(n):t;let i=s._getLabelTexts(o)[0];if(!i){const e=t.getAccessibilityInfo?.();if(e){i=e.description||e.children?.[0]?.getAccessibilityInfo?.()?.description||null}}const a="aria-labelledby";if(!i){let n;let o=t;let r=false;while(o&&!n&&!i){const s=t.getDomRef();n=s?.getAttribute(a);if(!n&&!r){r=true;const n=e.documentElement;if(n){const e=[...n.querySelectorAll("control-interactions")];const o=e.find(e=>Array.from(e.querySelectorAll(`control[name]`)).find(e=>e.getAttribute("name")===t.getMetadata().getName()));i=o?.querySelector("control")?.querySelector("defaultLabel")?.textContent}}if(!n&&!i){const t=s.querySelector("[aria-labelledby]");n=t?.getAttribute(a)}o=o.getParent?.()}if(!i&&n){const t=document.getElementById(n);i=t?.textContent||null}}return i||t.getMetadata().getName()};const b=async(o,r)=>{let s=o;while(s&&!r){r=s.getMetadata().getLibraryName();s=s.getParent()}if(!r){return null}const c=i._get(r);if(!c?.interactionDocumentation){return null}if(f.has(r)){return f.get(r)}const l=n.getLanguage();const u=e.getFallbackLocales(l);let d=null;while(u.length){const e=u.shift();const n=e?`interaction_${e}.xml`:`interaction.xml`;const o=sap.ui.require.toUrl(`${r.replace(/\./g,"/")}/i18n/${n}`);const s=`${r}:${e}`;if(f.has(s)){const n=f.get(s);if(n===null){t.debug(`Skipping loading of previously failed interaction XML for library ${r}, locale ${e}`);continue}return n}try{const t=await fetch(o);if(!t.ok){const e=t.statusText||`HTTP status ${t.status}`;throw new Error(`Failed to load resource: ${o} - ${e}`)}const e=await t.text();d=a.parse(e);if(d){f.set(r,d);break}}catch(e){if(!f.has(s)){f.set(s,null)}t.error(`Error loading interaction XML for library ${r}:`,e)}}return d};const y=(t,e)=>{const n=e.documentElement;if(!n){return[]}const o=[...n.querySelectorAll("control-interactions")];const r=o.find(e=>Array.from(e.querySelectorAll(`control[name]`)).find(e=>e.getAttribute("name")===t));if(!r){return[]}return[...r.querySelectorAll("interaction")].map(t=>{const e=Array.from(t.children).filter(t=>t.tagName==="kbd");const n=e.map(t=>{const e=d(t.textContent);return{raw:e,translated:g(e)}});return{kbd:n,description:m(t.querySelector("description"))?.innerHTML||""}})};let A;let L=false;const v=async t=>{if(L){return}L=true;setTimeout(()=>{L=false},300);const e=[];const n={};const o=new Map;let s;if(t){s=t.type==="focusin"?t.target:t.relatedTarget}s??=document.activeElement;const a=r.closestTo(s);const l=await b(null,"sap.ui.core");if(l){const t=i.getResourceBundleFor("sap.ui.core");const e=t.getText("Generic.Keyboard.Interaction.Text");n["sap.ui.core.Control"]={interactions:y("sap.ui.core.Control",l)};o.set(e,{index:-1,class:"sap.ui.core.Control",label:e,interactions:[{$ref:`docs/sap.ui.core.Control/interactions`}]})}let f=a;while(f){e.push(f);f=f.getParent()}for(let t=0;t<e.length;t++){const r=e[t];const s=r.getMetadata().getName();const i=p(r);const a=await b(r);const c=a?y(s,a):[];if(!i.length&&!c.length){continue}const l=r.getMetadata().getName();if(c.length>0){n[l]={interactions:c};i.push({$ref:`docs/${l}/interactions`})}const u=h(r,a);if(!o.has(u)){o.set(u,{interactions:[],label:u})}const f=o.get(u);f.index=t;f.id=r.getId();f.class=l;f.interactions.unshift(...i.reverse())}u.elements=Array.from(o.values()).sort((t,e)=>t.index-e.index).map(t=>{delete t.index;return t});u.docs=n;A?.postMessage(JSON.parse(JSON.stringify({service:c,type:"request",payload:{...u}})))};return{_isActive:false,async activate(t){A=t;if(this._isActive){return}this._isActive=true;await v();document.addEventListener("focusin",v);document.addEventListener("focusout",v)},deactivate(){if(!this._isActive){return}this._isActive=false;document.removeEventListener("focusin",v);document.removeEventListener("focusout",v)},_:{getNormalizedShortcutString:d,translateShortcut:g,annotateAndTranslateKbdTags:m,getInteractions:y,getCommandInfosFor:p,loadInteractionXMLFor:b,hasCacheEntry:t=>f.has(t),getInteractionXMLFromCache:t=>f.get(t),clearCache:()=>{f.clear()}}}});
//# sourceMappingURL=KeyboardInteractionDisplay.js.map