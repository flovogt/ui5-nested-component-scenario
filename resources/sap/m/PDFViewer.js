/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/core/Control","sap/ui/Device","sap/m/PDFViewerRenderManager","sap/m/PDFViewerRenderer","sap/base/Log","sap/base/assert","sap/ui/thirdparty/jquery","sap/ui/core/Lib"],function(e,t,r,i,o,s,n,jQuery,a){"use strict";var u=e.PDFViewerDisplayType;var l=t.extend("sap.m.PDFViewer",{metadata:{library:"sap.m",properties:{height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},source:{type:"sap.ui.core.URI",group:"Misc",defaultValue:null},errorMessage:{type:"string",group:"Misc",defaultValue:null,deprecated:true},errorPlaceholderMessage:{type:"string",group:"Misc",defaultValue:null},popupHeaderTitle:{type:"string",group:"Misc",defaultValue:null,deprecated:true},title:{type:"string",group:"Misc",defaultValue:null},showDownloadButton:{type:"boolean",group:"Misc",defaultValue:true},displayType:{type:"sap.m.PDFViewerDisplayType",group:"Misc",defaultValue:u.Auto},isTrustedSource:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{errorPlaceholder:{type:"sap.ui.core.Control",multiple:false},popupButtons:{type:"sap.m.Button",multiple:true,singularName:"popupButton"},_illustratedMessage:{type:"sap.m.IllustratedMessage",multiple:false,visibility:"hidden"},_nonTrustedIllustratedMessage:{type:"sap.m.IllustratedMessage",multiple:false,visibility:"hidden"}},events:{loaded:{},error:{parameters:{target:{type:"any"}}},sourceValidationFailed:{}}},renderer:o});l.prototype.init=function(){this._objectsRegister={};this._bIsPopupOpen=false;this._isError=false;this._initPopupControl();this._initPopupDownloadButtonControl();this._initErrorPlaceholderIllustratedMessageControl();this._initToolbarDownloadButtonControl();this._initOverflowToolbarControl();this._initControlState()};l.prototype._initControlState=function(){this._bRenderPdfContent=true};l.prototype.setWidth=function(e){this.setProperty("width",e,true);var t=this.$();if(t===null){return this}t.css("width",this._getRenderWidth());return this};l.prototype.setHeight=function(e){this.setProperty("height",e,true);var t=this.$();if(t===null){return this}t.css("height",this._getRenderHeight());return this};l.prototype.onBeforeRendering=function(){try{var e=this._getIframeDOMElement();e.remove()}catch(e){s.info(e)}};l.prototype.onAfterRendering=function(){var e=function(){var e=this._getIframeDOMElement();e.on("load",this._onLoadListener.bind(this));e.on("error",this._onErrorListener.bind(this))}.bind(this);try{this.setBusy(true);e()}catch(e){s.info(e);if(this._isError){this._isError=false;this._objectsRegister.getErrorPlaceholderIllustratedMessageControl().invalidate()}this.setBusy(false)}};l.prototype._fireErrorEvent=function(e){this._renderErrorState();this.fireError({target:e||null})};l.prototype._renderErrorState=function(){var e=this._objectsRegister.getToolbarDownloadButtonControl();e.setEnabled(false);var e=this._objectsRegister.getPopupDownloadButtonControl();e.setEnabled(false);this.setBusy(false);this._bRenderPdfContent=false;t.prototype.invalidate.call(this)};l.prototype._fireLoadedEvent=function(){this._bRenderPdfContent=true;this.setBusy(false);try{this._getIframeDOMElement().removeClass("sapMPDFViewerLoading")}catch(e){s.fatal("Iframe not found in loaded event");s.fatal(e)}this.fireEvent("loaded")};l.prototype._getHeaderInfo=function(e,t){if(window.fetch){return window.fetch(e,{method:t}).then(function(e){if(e.status===200){return e.headers.get("content-type")}else if(e.status===404){var r=new Error("Error fetching header: "+e.statusText);r.status=e.status;throw r}else{var r=new Error("Error in fetching header with method "+t+", status "+e.status+", statusText "+e.statusText);r.status=e.status;throw r}})}else{return new Promise(function(r,i){var o=new window.XMLHttpRequest;o.open(t,e,false);o.onload=function(){var e=o.status;if(e===200){var s=o.getAllResponseHeaders().toLowerCase().trim();var n=s.split("\n");var a=[];for(var u=0;u<n.length;u++){var l=n[u].split(": ");a[l[0].trim()]=l[1].trim()}r(a["content-type"])}else if(e===404){var p=new Error("Error fetching header: "+o.statusText);p.status=o.status;i(p)}else{var p=new Error("Error in fetching header with method "+t+", status "+o.status+" and statusText "+o.statusText);p.status=o.status;i(p)}};o.onerror=function(e){var e=new Error("Error in fetching header with method "+t+", status "+o.status+" and statusText "+o.statusText);e.status=o.status;i(e)};o.send(null)})}};l.prototype._onLoadListener=function(e){try{var t=jQuery(e.target);var i=true,n="";try{var a=t[0]?.contentWindow?.document?.body?.children}catch(e){if(r.browser.firefox){a=[]}}if(a?.length){try{var u=t[0].contentWindow.document.embeds;i=!!u&&u.length===1;if(i){n=u[0].attributes.getNamedItem("type").value}}catch(e){if(!r.browser.firefox&&this.fireEvent("sourceValidationFailed",{},true)){this._fireLoadedEvent();return}}if(i&&o._isSupportedMimeType(n)&&o._isPdfPluginEnabled()){this._fireLoadedEvent()}else{this._fireErrorEvent(e.target)}}else{if(!o._isPdfPluginEnabled()){this._fireErrorEvent(e.target);return}var l="HEAD";this._getHeaderInfo(this._sParametrizedSource,l).then(function(t){if(o._isSupportedMimeType(t)){this._fireLoadedEvent()}else{this._fireErrorEvent(e.target)}}.bind(this)).catch(function(t){if(t.status===404){this._fireErrorEvent(e.target)}else{s.warning("PDF is displayed based on isTrustedSource property skipping the content type validation.");this._fireLoadedEvent();this.fireEvent("sourceValidationFailed",{},true)}}.bind(this))}}catch(t){this._fireErrorEvent(e.target);s.fatal(false,"Fatal error during the handling of load event happened.");s.fatal(false,t.message)}};l.prototype._onErrorListener=function(){this._fireErrorEvent()};l.prototype.downloadPDF=function(){var e=window.open(this.getSource());e.opener=null;e.focus()};l.prototype._onAfterPopupClose=function(e){var t=this._objectsRegister.getPopup();t.removeAllContent();this._bIsPopupOpen=false};l.prototype._shouldRenderPdfContent=function(){return o._isPdfPluginEnabled()&&this._bRenderPdfContent&&this._isSourceValidToDisplay()};l.prototype._isSourceValidToDisplay=function(){var e=this.getSource();return e!==null&&e!==""&&typeof e!=="undefined"};l.prototype.invalidate=function(e){this._initControlState();t.prototype.invalidate.call(this,e)};l.prototype.open=function(){if(!this._isSourceValidToDisplay()){n(false,"The PDF file cannot be opened with the given source. Given source: "+this.getSource());return}else if(!o._isPdfPluginEnabled()){s.warning("The PDF plug-in is not available on this device.")}if(this._isEmbeddedModeAllowed()&&this.getIsTrustedSource()){this._openOnDesktop()}else{this._openOnMobile()}};l.prototype._openOnDesktop=function(){var e=this._objectsRegister.getPopup();if(this._bIsPopupOpen){return}this._initControlState();this._preparePopup(e);e.addContent(this);this._bIsPopupOpen=true;e.open()};l.prototype._openOnMobile=function(){var e=window.open(this.getSource());e.opener=null;e.focus()};l.prototype._getIframeDOMElement=function(){var e=this.$("iframe");if(e.length===0){throw Error("Underlying iframe was not found in DOM.")}if(e.length>1){s.fatal("Initialization of iframe fails. Reason: the control somehow renders multiple iframes")}return e};l.prototype._isEmbeddedModeAllowed=function(){return this._isDisplayTypeAuto()?r.system.desktop:this._isDisplayTypeEmbedded()};l.prototype._isDisplayTypeAuto=function(){return this.getDisplayType()===u.Auto};l.prototype._isDisplayTypeEmbedded=function(){return this.getDisplayType()===u.Embedded};l.prototype._isDisplayTypeLink=function(){return this.getDisplayType()===u.Link};l.prototype._isDisplayDownloadButton=function(){return this.getShowDownloadButton()||this._isDisplayTypeLink()||this._isDisplayTypeAuto()&&!this._isEmbeddedModeAllowed()};l.prototype._getLibraryResourceBundle=function(){return a.getResourceBundleFor("sap.m")};l.prototype._getIllustratedMessageErrorMessage=function(){return this.getErrorPlaceholderMessage()?this.getErrorPlaceholderMessage():this._getLibraryResourceBundle().getText("PDF_VIEWER_PLACEHOLDER_ERROR_TEXT")};l.prototype._getRenderWidth=function(){return this._bIsPopupOpen?"100%":this.getWidth()};l.prototype._getRenderHeight=function(){if(this._bIsPopupOpen){return"100%"}if(!this._isEmbeddedModeAllowed()){return"auto"}return this.getHeight()};l.prototype.exit=function(){jQuery.each(this._objectsRegister,function(e,t){var r=t(true);if(r){r.destroy()}});try{var e=this._getIframeDOMElement();e.off()}catch(e){s.info(e)}};i.extendPdfViewer(l);return l});
//# sourceMappingURL=PDFViewer.js.map